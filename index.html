<!doctype html>
<html>
<head>
	<meta name="generator" content="Hugo 0.26" />
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Viemacs Notes</title>
    <link href='/slate/stylesheets/monokai.css' rel="stylesheet" media="screen" />
<link href='/slate/stylesheets/screen.css' rel="stylesheet" media="screen" />
<link href='/slate/stylesheets/print.css' rel="stylesheet" media="print" />

    
<script src='/slate/javascripts/all.js'></script>

    
</head>
<body class="index" data-languages="[ &#34;go&#34; ,  &#34;c&#43;&#43;&#34; ,  &#34;shell&#34; ,  &#34;python&#34; ,  &#34;javascript&#34; ,  &#34;sql&#34; ]">
    <a href="#" id="nav-button">
        <span>
        NAV
        <img src='/slate/images/navbar.png'/>
      </span>
    </a>
    <div class="tocify-wrapper">
        
         <img src='/images/logo.png' />
        
        <div class="lang-selector">
            
            <a href="#" data-language-name="go">Go</a>
            
            <a href="#" data-language-name="c&#43;&#43;">C</a>
            
            <a href="#" data-language-name="shell">Shell</a>
            
            <a href="#" data-language-name="python">Python</a>
            
            <a href="#" data-language-name="javascript">Javascript</a>
            
            <a href="#" data-language-name="sql">SQL</a>
            
        </div>
         
        
        <div class="search">
            <input type="text" class="search" id="input-search" placeholder='Search'>
        </div>
        <ul class="search-results"></ul>
        
        <div id="toc">
        </div>
         
        
        

    </div>
    <div class="page-wrapper">
        <div class="dark-box"></div>
        <div class="content">
            
    
        

<h1 id="an-introduction">An Introduction</h1>

<p>We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:</p>

<ul>
<li>1) Respect the privacy of others.</li>
<li>2) Think before you type.</li>
<li>3) With great power comes great responsibility.</li>
</ul>

    
        

<h1 id="agile">Agile</h1>

    
        

<h2 id="scrum">Scrum</h2>

    
        

<h1 id="algorithm">Algorithm</h1>

    
        

<h2 id="huffman-encoding">Huffman Encoding</h2>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="ow">and</span> <span class="n">right</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">weight</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">weight</span>

    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">genHuffman</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
    <span class="n">nodeList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">)):</span>
        <span class="n">nodeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">(</span><span class="n">char</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodeList</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">nodeList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">nodeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="n">nodeList</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">right</span> <span class="o">=</span> <span class="n">nodeList</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">nodeList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">nodeList</span> <span class="k">else</span> <span class="n">Node</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">getFrequency</span><span class="p">(</span><span class="n">freq</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">/</span><span class="n">total</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>

<span class="c1"># test</span>
<span class="n">symbol</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">]</span>
<span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">genHuffman</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>

<span class="c1"># output</span>
<span class="c1"># space	7	111</span>
<span class="c1"># a	4	010</span>
<span class="c1"># e	4	000</span>
<span class="c1"># f	3	1101</span>
<span class="c1"># h	2	1010</span>
<span class="c1"># i	2	1000</span>
<span class="c1"># m	2	0111</span>
<span class="c1"># n	2	0010</span>
<span class="c1"># s	2	1011</span>
<span class="c1"># t	2	0110</span>
<span class="c1"># l	1	11001</span>
<span class="c1"># o	1	00110</span>
<span class="c1"># p	1	10011</span>
<span class="c1"># r	1	11000</span>
<span class="c1"># u	1	00111</span>
<span class="c1"># x	1	10010</span>

<span class="n">symbol</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;space&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;l&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;u&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
<span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">genHuffman</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>

<p>Huffman encoding goes from leaves to root, unlike Shanno-Fano encoding which goes from root to leaves.</p>

<p>A simple alg using a priority queue.</p>

<ol>
<li>Create a leaf-node for each symbol, with the info of the symbol&rsquo;s frequency.</li>
<li>Loop while there are more than 1 node in the queue

<ul>
<li>Replace the 2 nodes of lowest probability, with 1 node that takes the 2 nodes as children and its weight is the sum of the 2 nodes&rsquo; weight.</li>
</ul></li>
<li>The last one node is the root of the completed tree.</li>
</ol>

    
        

<h1 id="c">C</h1>

    
        

<h2 id="memory">Memory</h2>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">g_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// global, initialized</span>
<span class="kt">int</span><span class="o">*</span> <span class="n">g_p</span><span class="p">;</span>    <span class="c1">// global, uninitialized</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>           <span class="c1">// stack</span>
    <span class="kt">char</span> <span class="n">s</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ab&quot;</span><span class="p">;</span> <span class="c1">// s: stack, &quot;ab&quot; constant</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p1</span><span class="p">;</span>        <span class="c1">// static</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="s">&quot;12&quot;</span><span class="p">;</span> <span class="c1">// p2: stack, &quot;12&quot; constant</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// static</span>
    <span class="n">g_p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// heap</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>  <span class="c1">// heap</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">g_p</span><span class="p">,</span> <span class="s">&quot;12&quot;</span><span class="p">);</span> <span class="c1">// &quot;12&quot; constant</span>
                       <span class="c1">// the memory might be optimized by compiler and use the same memory as p2</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="内存分配方式中的-栈-堆-自由存储区-全局与静态存储区-常量存储区">内存分配方式中的 栈、堆-自由存储区、全局与静态存储区、常量存储区</h3>

<ul>
<li><p>栈<br />
栈是由编译器管理的变量存储区，在需要时分配，在不需要时自动释放。用户栈位于用户进程地址空间的顶部，在执行期间可以<strong>动态地扩展和收缩</strong>。栈中的变量有局部变量、函数参数，编译器也会用栈来实现函数调用。</p></li>

<li><p>堆<br />
堆是由用户程序主动管理的内存块，编译器不做管理。堆内存用 malloc/calloc/realloc 分配，用 free 释放；或用 new 分配，用 delete 释放。没有释放的内存在用户程序结束后由操作系统回收。堆可以*动态地扩展和收缩*。<br />
在 Linux 上，malloc 和 new 分配的内存都在堆上，但两种分配所执行的操作有所不同。</p></li>

<li><p>全局与静态存储区<br />
全局变量和静态变量的内存存储区。在 C++ 中为一块内存区。在 C 中，静态变量和初始化的全局变量在一块内存区，未初始化的全局变量在相邻的内存区。可通过 void* 来操作未初始化变量的存储区。全局和静态变量都在程序结束时由系统进行释放。</p></li>

<li><p>常量存储区<br />
常量存储，不允许修改其中的变量。</p></li>
</ul>

<h3 id="堆栈的区别">堆栈的区别</h3>

<p>堆和栈的区别是大家常说起的一个问题。</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>指针 a 在栈上分配了一段内存，malloc 在堆上分配了一段4个整型大小的内存，然后把这段内存的首地址返回给指针 a。</p>

<p>堆和栈的区别主要有5点。（中文中“堆栈”指栈。）</p>

<ol>
<li><p>管理方式<br />
栈由编译器自动管理；堆由用户程序主动管理，显示进行分配和释放。</p></li>

<li><p>空间大小<br />
栈一般有一定的空间大小，而且默认的空间大小较小，例如1M；而堆在32位系统下的地址空间就可以达到4G。</p></li>

<li><p>碎片<br />
栈是 FILO 队列，永远不会从中间 pop 内存块。而堆在大量的 malloc/free, new/delete 内存空间会产生许多的不连续，生成内存碎片。</p></li>

<li><p>分配方向<br />
堆地址的分配是从小往大，向着内存地址增加的方向进行；栈地址的分配是从大往小，向内存地址减小的方向进行。</p></li>

<li><p>分配方式 <strong>这部分解释有问题</strong><br />
栈的静态分配由编译器完成。堆是动态分配的，没有静态分配。
栈的动态分配，使用 malloc，但由编译器进行释放。</p></li>

<li><p>分配效率<br />
栈比堆的效率更高。栈在系统层有更多的支持，有专门的指令进行压栈和出栈，有专门的寄存器存放栈地址。堆由函数库提供支持。
在堆上分配一块内存时，库函数会按照特定算法在堆中查找足够大小的可用空间，如果由碎片过多等原因没有足够大小的空间，则调用系统功能去增加程序数据段的空间，以产生足够大小的内存。</p></li>
</ol>

<p>和栈相比，堆没有专门的系统层支持，可能引发用户态和核心态的切换（<strong>什么意思</strong>）使内存申请的代价更大，大量的分配和释放操作后容易产生大量内存碎片。在效率更重要的地方，比如函数调用，是利用栈来完成的。函数调用中的参数，返回地址，EBP，局部变量都由栈来存放。而堆比栈更灵活（<strong>怎么灵活的</strong>），在分配大量内存空间时，优先使用堆。</p>

<p>堆和栈都是对存空间的操作，要防止内存越界问题。内存越界会使程序产生意外的结果，或使程序崩溃。</p>

<h3 id="静态变量">静态变量</h3>

<ul>
<li><p>原因：控制函数中生存周期不依赖于函数自身周期的变量的可见性</p>

<p>函数内部的变量在其定义被执行时在栈上分配空间，在函数结束时会释放它在栈上分配的空间。如果要在一个函数的多次调用间传递数据，可以使用全局变量；如果要限制该变量的作用范围，则使用静态变量。控制作用范围，可以保持类的封装性，使成员对外不可见。</p></li>

<li><p>实现机制</p>

<p>静态数据成员要在程序开始运行时就存在。因为要独立于函数在栈上的空间，静态数据成员不能在函数内分配空间和进行初始化。有三个地方可以为静态变量分配空间：1 main 函数之间的全局数据定义/声明处；2 类外部接口的头文件中的类声明处（<strong>可以吗？</strong>）；3 类定义的内部实现（<strong>这是为什么可以？</strong>） 这是有类的成员函数定义。</p>

<p>静态变量存储在程序的静态存储区中，而不是在栈上。静态变量按出现的先后顺序初始化，如果有嵌套，则要保证所嵌套的成员已初始化。释放时则按相反顺序进行。</p></li>

<li><p>优势
静态变量是其所有对象共有共用的，只存储在一处，所有对象存取同一值，不需额外进行传递。它可以缩短子类对父类静态成员的访问时间，节省子类的空间。</p></li>
</ul>

<p><code>public</code> 的静态变量可以用 <code>ClassName::staticMemberName</code> 引用。</p>

<ul>
<li>注意点

<ul>
<li>静态数据成员必须进行初始化。<code>DataType ClassName::staticMemberName = value</code>
初始化在类外进行，用作用域运算符来标明所属类，不使用 static，private，public。
（使用 static 为定义新静态变量。）</li>
<li>类的静态成员函数属于整个类而非类的对象，所以它没有 this 指针，只能访问类的静态数据和静态成员函数。</li>
<li>静态成员函数不能定义为虚函数。</li>
<li>静态成员变量的地址（<strong>需要更多资料</strong>）是指向其数据类型的指针，静态成员函数的地址类型是 nonmember 函数指针。</li>
<li>静态成员函数是一个 callback 函数（<strong>为什么？</strong>），可以结合 C++ 和 C-based X window 系统，也可以应用于线程函数上（<strong>怎么用？</strong>）。</li>
<li>因为静态变量可以继承，子类可以定义与父类相同的静态变量来进行屏蔽。</li>
</ul></li>
</ul>

    
        

<h1 id="design">Design</h1>

    
        

<h2 id="design-pattern">Design Pattern</h2>

<p>设计模式是经过验证的代码设计经验的总结。其关注点是代码的可重用、易理解、可靠性。</p>

<p>设计模式的基本类型有：创建、结构、行为。</p>

<h3 id="设计原则">设计原则</h3>

<p>设计模式是设计原则的实现，以达到代码的复用和可维护。</p>

<ul>
<li><p>单一职责原则 Single Responsibility Principle</p></li>

<li><p>开闭原则 Open Closed Principle<br />
Software entities should be open for extension, but closed for modification. 模块应对扩展开放，对修改关闭。</p></li>

<li><p>里氏代换原则 Liskov Substitution Principle<br />
子类可代替父类运行。这种代换是继承利用的基础。</p></li>

<li><p>依赖倒转原则 Dependency Inversion Principle<br />
子类代替父类后，程序的行为不变化。这是面向对象设计的标志。</p></li>

<li><p>接口隔离原则 Interface Segregation Principle<br />
各接口间互不影响。每个接口可以做而且仅做自己需要做和应该做的事。不是所有可以做的事都应放到一个接口中。</p></li>

<li><p>合成聚合复用原则 Composite/Aggregate Reuse Principle<br />
应优先使用合成与聚合，而不是继承。合成复用原则是在新对象中使用已有对象，新对象通过向已有对象委派来复用已有功能。使各个类之间的联系尽量少，才好提高扩展性和可维护性。</p></li>

<li><p>迪米特最小知识原则 Principle of Least Knowledge<br />
各个对象对其他对象的了解应尽可能少。</p></li>
</ul>

<p>在解决问题时，设计模式可以帮忙我们在更高的抽象层次上工作。先是对问题的分析，了解问题中的因果关系，看使用模式的先决条件是否满足。然后根据分析给出解决方案。解决方案不是具体的设计和实现，而是对问题做抽象描述，表明如何用元素的组合而解决问题。</p>

<h3 id="创建">创建</h3>

<ul>
<li><strong>单例模式</strong> Singleton 下一个类仅有一个实例和一个全局访问点。要注意单例模式在使用多线程、序列化、类装载器（multi-threading, serialization, class loaders）时的问题。
<em>适用条件</em>: 类只能有一个实例，可以从全局访问；实例可通过子类扩展。</li>
<li><strong>工厂模式</strong> Factory Method 定义一个用于创建对象的接口，由子类确定实例化哪个对象，使类的实例化延后到子类。
<em>适用条件</em>: 一个类希望/需要由其子类来创建对象。</li>
<li><strong>抽象工厂模式</strong> Abstract Factory 不指定具体的类，仅提供一个创建一组相关/相依赖对象的接口。
<em>适用条件</em>: 只提供接口而不是实现。联合使用一系列的对象。</li>
<li><strong>建造者模式</strong> Builder 将（复杂）对象的构建和表示分离，使同样的构建过程可以创建不同的表示。
<em>适用条件</em>: 对象创建的算法应独立于对象，或对不同的对象有不同的表示。</li>
<li><strong>原型模式</strong> Prototype 用原型的实例来指定所创建对象的种类，并通过复制这个原型来创建新的对象。
<em>适用条件</em>: 在运行时才指定实例化的类，如动态装载；类的实例只会是几个不同状态组合中的一种时。</li>
</ul>

<h3 id="结构">结构</h3>

<ul>
<li><strong>适配器模式</strong> Adapter 将一个类的接口转换成另一个接口，使接口不兼容的类可以一起工作。
<em>适用条件</em>: 使用已存在的类，但接口不合要求；新建可复用的类，与不相关或不可预见的类兼容。</li>
<li><strong>桥接模式</strong> Bridge 将类的抽象部分和实现部分分离，分别独立改变。
<em>适用条件</em>:</li>
<li><strong>装饰模式</strong> Decorator 向对象动态增加额外职责。比生成子类更灵活地扩展一个类的功能。
<em>适用条件</em>:</li>
<li><strong>组合模式</strong> Composite 将对象组合成表达整体与部分关系的树形层次结构，使单个对象和复合对象在使用上一致。
<em>适用条件</em>:</li>
<li><strong>外观模式</strong> Facade 为子系统的一组接口提供一致的界面，定义高层接口，增加子系统的易用性。
<em>适用条件</em>:</li>
<li><strong>享元模式</strong> Flyweight 用共享技术有效支持大量细粒度的对象。
<em>适用条件</em>:</li>
<li><strong>代理模式</strong> Proxy 为其他对象提供代理，用代理来控制对象的访问。
<em>适用条件</em>:</li>
</ul>

<h3 id="行为">行为</h3>

<ul>
<li><strong>模版模式</strong> Template Method 定义方法中的算法骨架，将部分步骤延后到子类中，使子类不改变算法结构而重定义算法中的某些步骤。
<em>适用条件</em>:</li>
<li><strong>命令模式</strong> Command 将请求封装为对象，？？使用不同请求来对接收者进行参数化？？，可将请求排队、取消、记录日志。
<em>适用条件</em>:</li>
<li><strong>迭代器模式</strong>
<em>适用条件</em>:</li>
<li><strong>观察者模式</strong> Observer 在对象间建立一对多的依赖关系，当一个对象改变时，所有依赖于它的对象都自动刷新。
<em>适用条件</em>:</li>
<li><strong>中介者模式</strong> Mediator 封装一系列的对象交互，使各对象不需要显示相互引用，松耦合，并可以独立改变对象间的交互。
<em>适用条件</em>:</li>
<li><strong>备忘录模式</strong> Memento 不破坏对象的封装，捕获对象内部的状态并在对象外部保存，这可将对象恢复到保存时的状态。
<em>适用条件</em>:</li>
<li><strong>解释器模式</strong> Interpreter 定义一个给定语言的文法表示和解释器，来表示解释此语言的语句。
<em>适用条件</em>:</li>
<li><strong>状态模式</strong> State 允许对象在内部状态改变时改变行为，像是对象所属的类发生了变化。
<em>适用条件</em>:</li>
<li><strong>策略模式</strong> Strategy 定义并封装一系列的算法，并使它们可相互替换，使算法变化独立于使用者。
<em>适用条件</em>:</li>
<li><strong>责任链模式</strong> Chain of Responsibility 解耦请求的发送者和接收者。将多个可能处理请求的对象连成一条链，请    <em>适用条件</em>:
求在链上传递，直到有一个对象处理它。</li>
<li><strong>访问者模式</strong> Visitor 表示对一个对象中元素的操作，可以定义作用于元素的新操作而不改变元素的类。
<em>适用条件</em>:</li>
</ul>

    
        

<h2 id="reactive-system">Reactive System</h2>

<h3 id="响应式系统-响应式编程">响应式系统，响应式编程</h3>

<p>事件驱动实现响应式编程，消息驱动实现响应式系统。</p>

<p>响应式编程强调的是数据流而非控制流。</p>

<p>例子：</p>

<ul>
<li>Futures / Promises：值的容器，many-read and single-write</li>
<li>响应式 流：无限制的数据处理流，支持异步，非阻塞，多个源与目的</li>
<li>反压转换管道 Back-pressure transformation pipelines</li>
<li>数据流变量：依赖于输入，过程procedures 或其他单元的 单赋值变量（存储单元）single assignment variables，能够自动更新值的改变。如：表格软件中一个单元格值的改变会影响到所有依赖于它的函数，顺流而下地使它们产生新的值。
<br /></li>
</ul>

<p>JVM 中支持 非阻塞式反压异步流，响应式编程 的流行库有：Akka Streams, Ratpack, Reactor, ExJava, Vert.x</p>

<p>响应式编程的基本好处是：提高多核和多 CPU 硬件的计算资源利用率；通过减少序列化点来提高性能（阿姆达尔定律，古瑟通用可伸缩定律 Amdahl, Guenther）。</p>

<p>响应式编程中，active 活动组件间一般不需要明确的协作，而避开了传统的编程范式的做法：尽力提供一个简单直接的可持续的方法来处理异步非阻塞计算和 I/O。</p>

<p>响应式编程的价值在于组件的创建和工作流的组合。在异步执行上加入<strong>反压</strong>以避免过度使用/无限度地消耗资源。</p>

<p>为在更高层次上理清一个系统，设计响应式系统，需要为其设计响应式架构。响应式编程仅是一种编程范式，要注意它的适用条件和情形。</p>

<ol>
<li><p>事件驱动与消息驱动</p>

<p>响应式编程的着眼点在短时数据流链条上的计算，因而使用事件驱动；响应式系统关注于通过分布式系统的通信和协作所得到的弹性和韧性，使用消息驱动 messaging。</p>

<p>事件驱动的数据流驱动模型，拥有 long-live addressable 长期存活可寻址 组件的消息驱动系统，两者的不同在于，消息具有固定的导向，事件没有；消息会有一个明确的去向，而事件只是一个等待被观察的信息。消息式结构更适用于异步，因为消息的发送与接收和发送者与接收者是分离的。</p>

<blockquote>
<p>一条消息就是一则被送往一个明确目的地的数据。一个事件则是达到某个给定状态的组件发出的一个信号。在一个消息驱动的系统中，可寻址到的接收者等待消息的到来然后响应它，否则保持休眠状态。在一个事件驱动系统中，通知的监听者被绑定到消息源上，这样当消息被发出时它就会被调用。这意味着一个事件驱动系统专注于可寻址的事件源，而消息驱动系统专注于可寻址的接收者。</p>
</blockquote>

<p>分布式系统需要通过消息在网络上传输进行交流，以实现其沟通基础，而事件的发出则是本地的。常见的做法是在底层通过发送包裹着事件的消息来搭建跨网络的事件驱动系统，这样能维持在分布式环境下事件驱动编程模型的相对简易，可以用在合理范围内的特殊案例上。</p>

<p>分布式环境下的事件驱动在编程模型的抽象性和简易性上有好处，但在控制性上有欠缺。消息强迫我们去拥抱分布式系统的真实性和一致性。你需要去考虑局部错误，错误侦测，丢弃/复制/重排序消息 （partial failures, failure detection, dropped/duplicated/reordered），还有一致性问题，管理多个并发真实性（并发真实性？）。你需要面对它们，处理它们，而不是藏在低劣的抽象层后，假装网络并不存在，像是 EJB, RPC, CORBA, XA。</p>

<p>在设计中，这种语义和适用性上的不同对应用有深刻的影响，包括分布式系统的复杂性中的弹性，韧性，移动性，位置透明和管理。</p>

<p>在使用了响应式编程技术的响应式系统中，有用于沟通的消息，也不呈现现实的事件。</p></li>

<li><p>响应式系统</p></li>

<li><p>响应式程序与系统</p></li>

<li><p>弹性</p></li>

<li><p>韧性</p></li>

<li><p>生产效率</p></li>

<li><p>编程与系统关联</p></li>

<li><p>总结</p></li>
</ol>

<hr />

<p>流，轻量，<strong>实时</strong></p>

<p>分布式环境下，实现技术，工具，设计模式</p>

<p>SCALE, 负载平衡，<strong>主动执行</strong></p>

<p>FRP（FP） is misused</p>

<p>RP，由有效信息推动，而非执行流程/线程推动的控制流。信息实现异步非阻塞与 IO 非绑定。</p>

    
        

<h1 id="dist">Dist</h1>

    
        

<h2 id="kafka">Kafka</h2>

    
        

<h1 id="editor">Editor</h1>

<h2 id="emacs">Emacs</h2>

<h3 id="emacs-config-file">Emacs Config File</h3>

<p><a href="./editor/init.el">init.el</a></p>

    
        

<h2 id="vim-shortcuts">VIM Shortcuts</h2>

<h3 id="退出">退出</h3>

<ul>
<li>w filename: 保存正在编辑的文件filename</li>
<li>wq filename: 保存后退出正在编辑的文件filename</li>
<li>q：退出不保存。</li>
</ul>

<h3 id="窗口操作">窗口操作</h3>

<ul>
<li>ctrl+w p: 在两个分割窗口之间来回切换。</li>
<li>ctrl+w j: 跳到下面的分割窗</li>
<li>ctrl+w h: 跳到左边的分割窗。</li>
<li>ctrl+w k: 跳到上面的分割窗。</li>
<li>ctrl+w l: 跳到右边的分割窗。</li>
</ul>

<h3 id="移动">移动</h3>

<pre><code>h,j,k,l: 左，下，上，右。
w: 下一个词的词首。
e:下一个词的词尾。
b:上一个词的词首。
&lt;&gt;: v 模式选中后进行缩进。
</code></pre>

<h3 id="跳转">跳转</h3>

<pre><code>%: 可以匹配{},&quot;&quot;,(),[]之间跳转。
H、M、L：直接跳转到当前屏幕的顶部、中部、底部。
#H：跳转到当前屏的第#行。
#L：跳转到当前屏的倒数第#行。
zt: 当前编辑行置为屏顶。
zz: 当前编辑行置为屏中。
zb: 当前编辑行置为屏底。
G：直接跳转到文件的底部。
gg: 跳转到文件首。
():跳转到当前的行首、行尾。
{}：向上、向下跳转到最近的空行。
[{：跳转到目前区块开头。
]}：跳转到目前区块结尾。
0: 跳转到行首。
$: 跳转到行尾。
2$: 跳转到下一行的行尾。
#：跳转到该行的第#个位置。
#G: 15G,跳转到15行。
:#：跳转到#行。
f'n'：跳转到下一个&quot;n&quot;字母后。
ctrl+b: 向后翻一页。
ctrl+f：向前翻一页。
ctrl+u: 向后翻半页。
ctrl+d: 向前翻半页。
ctry+e: 下滚一行。
</code></pre>

<h3 id="选择">选择</h3>

<pre><code>1.V: 选择一行。
2.^V: 矩形选择。
3.v3w: 选择三个字符。  
</code></pre>

<h3 id="编辑">编辑</h3>

<pre><code>1. 新增：
    i: 光标前插入。
    I: 在当前行首插入。
    a: 光标后插入。
    A: 当前行尾插入。
    O: 在当前行之前插入新行。
    o: 在当前行之后插入新行。
2. 修改 c(change) 为主：
    r: 替换光标所在处的字符。
    R：替换光标所到之处的字符。
    cw: 更改光标所在处的字到字尾处。
    c#w: c3w 修改3个字符。
    C：修改到行尾。
    ci'：修改配对标点符号中的文本内容。
    di'：删除配对标点符号中的文本内容。
    yi'：复制配对标点符号中的文本内容。
    vi'：选中配对标点符号中的文本内容。
    s：替换当前一个光标所处字符。
    #S：删除 # 行，并以新文本代替。
3. 删除 d(delete) 为主：
    D：删除到行尾。
    X: 每按一次，删除光标所在位置的前面一个字符。
    x: 每按一次，删除光标所在位置的后面一个字符。
    #x: 删除光标所在位置后面6个字符。
    d^: 删至行首。
    d$: 删至行尾。
    dd:(剪切)删除光标所在行。        
    dw: 删除一个单词/光标之后的单词剩余部分。
    d4w: 删除4个word。
    #dd: 从光标所在行开始删除#行。
    daB: 删除{}及其内的内容。
    diB: 删除{}中的内容。
    n1,n2 d：将n1,n2行之间的内容删除。
4. 查找：
    /： 输入关键字，发现不是要找的，直接在按n，向后查找直到找到为止。
    ?： 输入关键字，发现不是要找的，直接在按n，向前查找直到找到为止。
    *: 在当前页向后查找同一字。
    #: 在当前页向前查找同一字。
5. 复制 y(yank)为主：
    yw: 将光标所在之处到字尾的字符复制到缓冲区中。
    #yw: 复制#个字到缓冲区。
    Y：相当于yy, 复制整行。
    #yy:表示复制从光标所在的该行往下数#行文字。
    p: 粘贴。所有与y相关的操作必用p来结合粘贴。
    n1,n2 co n3：复制第n1行到第n2行之间的内容到第n3行后面。
6. 大小写转换：
    gUU: 将当前行的字母改为大写。
    guu: 将当前行的字母改为小写。
    gUw: 将当前光标下的单词改为大写。
    guw: 将当前光标下的单词改为小写。
    a. 整篇大写:
    ggguG
    gg: 光标到文件第一个字符。
    gu: 把选择范围全部小写。
    G: 到文件结束。
    b. 整篇小写：gggUG
7.  其它：
    J：当前行和下一行合并成一行。
8.  移动：
    n1,n2 m n3：将n1行到n2行之间的内容移至n3行下。
</code></pre>

    
        

<h1 id="errors">Errors</h1>

<aside class="notice">This error section is stored in a separate file, errors.md. DocuAPI allows you to split the single page documentation in as many files as needed. Files are included in the  default Hugo page order . One way of ordering the pages is by setting the page `weight` in the front matter. Pages with lower weight will be listed first.</aside>

<p>The Kittn API uses the following error codes:</p>

<table>
<thead>
<tr>
<th>Error Code</th>
<th>Meaning</th>
</tr>
</thead>

<tbody>
<tr>
<td>400</td>
<td>Bad Request &ndash; Your request sucks</td>
</tr>

<tr>
<td>401</td>
<td>Unauthorized &ndash; Your API key is wrong</td>
</tr>

<tr>
<td>403</td>
<td>Forbidden &ndash; The kitten requested is hidden for administrators only</td>
</tr>

<tr>
<td>404</td>
<td>Not Found &ndash; The specified kitten could not be found</td>
</tr>

<tr>
<td>405</td>
<td>Method Not Allowed &ndash; You tried to access a kitten with an invalid method</td>
</tr>

<tr>
<td>406</td>
<td>Not Acceptable &ndash; You requested a format that isn&rsquo;t json</td>
</tr>

<tr>
<td>410</td>
<td>Gone &ndash; The kitten requested has been removed from our servers</td>
</tr>

<tr>
<td>418</td>
<td>I&rsquo;m a teapot</td>
</tr>

<tr>
<td>429</td>
<td>Too Many Requests &ndash; You&rsquo;re requesting too many kittens! Slow down!</td>
</tr>

<tr>
<td>500</td>
<td>Internal Server Error &ndash; We had a problem with our server. Try again later.</td>
</tr>

<tr>
<td>503</td>
<td>Service Unavailable &ndash; We&rsquo;re temporarially offline for maintanance. Please try again later.</td>
</tr>
</tbody>
</table>

    
        

<h1 id="golang">Golang</h1>

<h2 id="the-design">The Design</h2>

<p>Go 看上去是 C 而不是 C++。我自己在学习和项目使用时，并没有很在意 C 和 C++ 的区别，但看到 Go 时，发现了许多不同。</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="kn">package</span> <span class="nx">foobar</span>

<span class="kd">type</span> <span class="nx">Bar</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">n</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bar</span><span class="p">)</span> <span class="nx">foo</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">n</span>
<span class="p">}</span>
</code></pre></div>

<p>Go 语言在设计中的感觉是<strong>追求显式表达，避免隐式表达</strong>。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;a local variable&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>

<p>Python 中也有相似的地方，在类中显式地写出<code>self</code>，对<code>self</code>的操作才是对对象的操作。<br />
但 Go 中向对象增加方法<code>method</code>也要显式地写出对象。</p>

<p>Go 中不支持参数默认值，函数重载。C 也不支持，是 C++ 支持。<br />
参数默认值其实是一种隐式表达。调用者仅看名字，不去查看默认参数时，有时会遇到参数默认值导致问题，给调试带来不少麻烦。</p>

<p>一个表达的意义应该是唯一的，没有二义性。凡是可能导致二义性的行为都应是禁止或尽量避免的。比如函数默认参数，比如类的默认拷贝构造函数。还有一个书写方便但让项目更难调试的功能：自动类型转换。</p>

<p>进一步，一种表达的写法也应尽可能是唯一的。在 Go 语言的写法中，就没有单行 <code>if</code> 语句要不要加括号/braces 这样的问题。<code>if else</code> 中 <code>else</code> 的位置也是固定的。另一方面，你可以用无条件的 <code>switch</code> 来更清楚地表达 <code>if-then-else</code>。</p>

<p>引用某匿名用户的话：“语法糖好吃不一定有益。”</p>

    
        

<h2 id="object-orientation">Object Orientation</h2>

<p>Golang 中没有 <code>class</code>。它的面向对象的实现，可以用 <code>struct</code> 来做。</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="kd">type</span> <span class="nx">Record</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Title</span> <span class="kt">string</span>
    <span class="nx">Dept</span> <span class="kt">string</span>
    <span class="nx">value</span> <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div>

<p>Golang 中变量和函数首字母大写相当于 <code>public</code>， 小写相当于 <code>private</code>，在包和结构体中都是如此。</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="nx">Record</span><span class="p">)</span> <span class="nx">Publish</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Title</span><span class="p">)</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Record</span><span class="p">)</span> <span class="nx">setTitle</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="nx">s</span> <span class="p">}</span>
</code></pre></div>

<p>Golang 中结构体的方法声明与众不同，是普通函数的方式，并在 <code>func</code> 后加上函数操作的对象，对象加 <code>*</code> 则传指针，不加时传值。</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="nx">record</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Record</span><span class="p">{}</span>
<span class="nx">record</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&quot;New Time&quot;</span>
<span class="nx">record2</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Record</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="s">&quot;Two&quot;</span><span class="p">}</span>
<span class="nx">record3</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Record</span><span class="p">)</span>
<span class="nx">record3</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&quot;Three&quot;</span>
<span class="nx">record4</span> <span class="o">:=</span> <span class="nx">Record</span><span class="p">{}</span>
<span class="nx">record4</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&quot;Four&quot;</span>
<span class="nx">record5</span> <span class="o">:=</span> <span class="nx">Record</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="s">&quot;Five&quot;</span><span class="p">}</span>
</code></pre></div>

<p>对象实例化。加 <code>&amp;</code> 和 <code>new</code> 时，生成指针对象。一般当对象较小时，传值较好；对象较大时，传指针较好。</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="kd">func</span> <span class="nx">NewRecord</span><span class="p">(</span><span class="nx">param</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">Record</span>
<span class="kd">func</span> <span class="nx">NewRecord</span><span class="p">(</span><span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Record</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Record</span><span class="p">{}</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="nx">title</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="nx">record</span> <span class="o">:=</span> <span class="nx">NewRecord</span><span class="p">(</span><span class="s">&quot;Initialized&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Golang 并没有构造函数，一般也不要用。如果想在初始化时额外做些事的话，要自己写方法来生成实例。</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="kd">type</span> <span class="nx">Record</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Title</span> <span class="kt">string</span>
    <span class="nx">Dept</span> <span class="kt">string</span>
    <span class="nx">value</span> <span class="kt">int</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Archive</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Record</span>
    <span class="nx">Dept</span> <span class="kt">string</span>
    <span class="nx">Location</span> <span class="kt">string</span>
<span class="p">}</span>
<span class="nx">archive</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Archive</span><span class="p">{}</span>
<span class="nx">archive</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&quot;Archive&quot;</span>
<span class="nx">archive</span><span class="p">.</span><span class="nx">Dept</span> <span class="p">=</span> <span class="s">&quot;A-20&quot;</span>
<span class="nx">archive</span><span class="p">.</span><span class="nx">Record</span><span class="p">.</span><span class="nx">Dept</span> <span class="p">=</span> <span class="s">&quot;Center&quot;</span>
<span class="c1">// partial print</span>
<span class="o">&amp;</span><span class="p">{{</span> <span class="nx">Center</span> <span class="p">}</span> <span class="nx">A</span><span class="o">-</span><span class="mi">20</span> <span class="p">}</span>
</code></pre></div>

<p>Golang 的继承/组合，cmoposition。在属性冲突时，使用 <code>Archive</code> 中的，而 <code>Record</code> 中的用 <code>archive.Record.Dept</code> 访问。</p>

<p>Golang 不支持重载，重载属于 <code>redeclared</code> 错误，但可以使用不定参数来处理不同参数调用。<br />
<code>func (r *Record) bar(args ...interface{}) { fmt.Println(args) }</code></p>

<p><strong>接口</strong></p>

<p>TBC</p>

    
        

<h1 id="javascript">Javascript</h1>

<h2 id="thoughts">Thoughts</h2>

<h3 id="why-javascript">Why JavaScript</h3>

<p>I use JavaScript to develop products because it seems faster and easier.
Use web browsers as JVM, use DOM to build UI, and sue JS to implement business logic.</p>

<h3 id="react">React</h3>

<p>React provides a different way of organize frontend codes. And I like it very much.</p>

<p>Before writing WebApp, my programming practice uses Cpp mostly.
So class and components are very handy, and very easy to understand.
Different from the noodle of Vanilla JS in complex application,
React divides the system to proper components, and makes the data flow in one direction only.</p>

<p>Since more services are moved to Cloud, there are more business-oriented applications
which are more complex than client/consumer oriented apps.
React can make some real differences in these fields.</p>

<h3 id="vanilla-js">Vanilla JS</h3>

<p>Some time it seems Vanilla JS is not important, bacause lib like jQuery wrapped up many things.
During the early stage of developing an app, you might need to find certain libs to solve the problems you are facing.
When you put those codes together, you might encounter problems, and to handle those problems, Vanilla JS is very helpful in locating the problem and finger out what&rsquo;s wrong.</p>

<p>Another thing is if you need to glue some modules together, sometimes you need to use Vanilla JS to do the job, instead of find another lib to glue modules.</p>

<h3 id="react-createclass-vs-component">React createClass vs Component</h3>

<p>ES6 class might be just a syntactic sugar instead of real class, but things are headed towards this way.
I choose to write my code the ES6 way when it&rsquo;s convenient.
As to Component, it&rsquo;s neater than createClass.
No trailing comma, less extra parentheses, and easier to read.</p>

<p><a href="https://reactjsnews.com/composing-components" title="React.Component vs React.createClass">Ref</a></p>

<h2 id="introduction">Introduction</h2>

<h3 id="approaches-to-create-objects">Approaches to Create Objects</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;direct assigned&#39;</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">newstr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s2">&quot;String instance initialization&quot;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s2">&quot;arg_name&quot;</span><span class="p">,</span> <span class="s2">&quot;console.log(arg_name)&quot;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">();</span>
</code></pre></div>

<ul>
<li>Inner Object
JS has two types of inner object:

<ul>
<li>original object, eg: <code>Function, Object, String</code></li>
<li>run-time object / host object, eg: <code>window, document</code></li>
</ul></li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">let</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{</span><span class="nx">k</span><span class="o">:</span><span class="s1">&#39;record&#39;</span><span class="p">,</span> <span class="nx">v</span><span class="o">:</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]}</span>
<span class="kd">let</span> <span class="nx">bar</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">();</span>
<span class="nx">bar</span><span class="p">.</span><span class="nx">k</span> <span class="o">=</span> <span class="s1">&#39;record&#39;</span><span class="p">;</span>
</code></pre></div>

<ul>
<li>JSON Object
JS can creates objects via JSON objects.<br />
And JS can turn Object instance to JSON object.</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">k</span> <span class="o">=</span> <span class="s1">&#39;record&#39;</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">v</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">Bar</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">Bar</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">k</span> <span class="o">=</span> <span class="s1">&#39;record&#39;</span><span class="p">;</span>
<span class="nx">Bar</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">v</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>
</code></pre></div>

<ul>
<li>Customized Object
<code>Function</code> can be used to create customized object.

<ul>
<li>use <code>this</code><br />
the attributes and methods are initialized for every instance</li>
<li>use <code>prototype</code><br />
the attributes and methods are only references on every instance</li>
</ul></li>
</ul>

<h2 id="number">Number</h2>

<h3 id="integer">Integer</h3>

<blockquote>
<p>环境 64位 Linux, nodejs v7.2.1</p>
</blockquote>

<ul>
<li>16位数 可以正确显示</li>
<li>17位数 17位上开始失准; 然后归双; 然后舍入, 17位为0</li>
<li>18-22位数 16位后直接丢失, 变为0</li>
<li>23位以上, 变为浮点数, 进行 parseInt() 会出错</li>
</ul>

<h2 id="delete-operator-in-js"><em>delete</em> operator in JS</h2>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/delete#section_5">Ref</a></p>

<p>The <strong>delete</strong> operator removes a property from an object.</p>

<pre><code>delete expression
</code></pre>

<p>where <code>expression</code> should evaluate to a property reference.</p>

<pre><code>delete object.property
delete object['property']
</code></pre>

<p>Parameters</p>

<p><strong>object</strong> The name of an object, or an expression evaluating to an object.</p>

<p><strong>property</strong> The property to delete.</p>

<p>N.B., the <strong>delete</strong> operator has <strong>nothing</strong> to do with directly freeing memory.
Memory management is done indirectly via breaking references.</p>

<ul>
<li><em>delete</em> will return <em>true</em> on successful deletion, or it will <em>false</em> or raises a SyntaxError or ReferenceError in strict mode.</li>
<li>Notice that <em>delete</em> will also return <em>true</em> if the target property does not exist and <em>delete</em> has no effect.</li>
<li>Delete can only remove own properties. If the prototype chain has a property with the same name, then the object will use it.</li>
<li>An property declared with <em>var</em> cannot be deleted from global/function scope.</li>
<li><em>function</em> can only be deleted if it&rsquo;s a part of an object.</li>
<li>An property declared with <em>let</em> or <em>const</em> cannot be deleted from their scope.</li>
<li>Non-configurable properties cannot be <em>deleted</em>, which includes properties of built-in objects like <em>Math</em>, <em>Array</em>, <em>Object</em>, and properties created by Objects.defineProperty().</li>
</ul>

<h2 id="array">Array</h2>

<h3 id="array-loop">Array Loop</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">;</span>

<span class="nx">arr</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{});</span>

<span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">e</span><span class="p">});</span>

<span class="nx">arr</span><span class="p">.</span><span class="nx">every</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">e</span><span class="p">});</span>

<span class="nx">arr</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">e</span><span class="p">});</span>
</code></pre></div>

    
        

<h2 id="js-development-environment">JS Development Environment</h2>

<p>随着前端和 Node.JS 的发展, 以及页面的APP化, JS 成为开发应用的不错的选择.
前后通吃, 语法灵活, 发展迅速, 对提高开发效率很有帮助.</p>

<p>JS 开发发展迅速带来的一个问题是工具和库众多, 开发中选择什么工具成了一个问题.
我从两年前真正开始写JS开始尝试了一些工具和库, 试过之后才知道什么更适合自己.</p>

<h3 id="编辑器">编辑器</h3>

<p>单就文本编辑器而言, 当然还是首推 Emacs 和 Vim. 除这两者之外, 还有许多不错和编辑器和IDE.</p>

<ul>
<li>Sublime 比较灵活, 有插件, 可配置. 上手容易, 但要用上各种插件有点繁.</li>
<li>Atom 比较适合前端技术栈, github 出品, 应该不错. 没真正用过.</li>
<li>Brackets 使用时感觉很方便, web 预览功能很不错. 当时版本较早, 有一些bug, 现在应该更好用了.</li>
<li>WebStorm 完整的 IDE 的样子, 对 JS 开发非常不错, 前端, Node.JS, git 都支持, 也有 emacs 模式. 用习惯之后对生产效率应该会有提升.</li>
</ul>

<h3 id="打包">打包</h3>

<p>打包包括了开发上线所需的预编译, 压缩, 转换, 优化, 构建任务.</p>

<p>现在使用的是 Webpack. 既然 Webpack 有丰富的loader, 方便的 API, 良好的生态环境, 为什么不用它呢?</p>

<p>由于接触JS工程比较晚, 有 Webpack 可用, 对早期的 Grunt 和后来的 Gulp 并不了解.
大家似乎是觉得 Grunt 配置麻烦, 效率不高, 于是转向 Gulp.
还有就是使用 NPM 的构建方式, 我不怎么会用, 感觉和上面三种打包工具不属一类工具.
在自己的工程中尝试使用过 Grunt 和 Gulp, 由于工程较小, 使用起来并没有感觉方便.
在压缩js, 分发文件方面, 比自己写 Python 脚本更复杂.</p>

<p>Grunt 要完成配置之后, 在日常开发中, 通过一个命令就能自动完成文件合并压缩, 上线构建, 在线重载(live-reload).
在项目变得复杂之后, 仅靠配置难以满足需求, 只有增加插件配置项. 而越来越多的配置项使得Grunt的配置变得过于麻烦.</p>

<p>Gulp 则是提供类 Linux 的文件流操作, 以编程的方式组建任务, 来解决越来越多的配置项的问题.</p>

<hr />

<h3 id="webpack-vue-心得">webpack + vue 心得</h3>

<p>(ref: wechat 医小生与程序猿 (doctor_programmer))</p>

<ol>
<li><p><strong>要单页面还是多页面</strong>。我们的项目比较大，目录又多又深，如果用配合vue-router做成整体的单页面应用，必然会因多级嵌套路由而造成各种困扰。所以最终决定一个功能模块一个页面，各模块自己做成SPA。这个方案也为后面进行多入口打包带来了麻烦。</p></li>

<li><p><strong>公共框架如何处理。</strong>  所谓公共框架就是像vue、jquery、bootstrap这的第三方框架。 它们基本不会改动，所以肯定是要单独打成一个包的，充分利用缓存。另外一个问题就是，这些框架的代码放哪里好，有人用bower管理，有人用npm管理，或者是像我们之前那样在项目中放一个lib目录，下载好框架代码后就放进去不动了。不过现在业界普遍都推commonjs规范了，所以用npm来管理是个趋势。</p></li>

<li><p><strong>项目的公用组件如何打包。</strong>  既然是用vue，那肯定会写很多公共的组件了，这些组件肯定不能和第三方库打包到一起，也不要和业务代码打包在一起，因为业务代码总改动，而公共组件相对改动也比较少。最好是把所有的组件打成一个包。然而webpack的设计思想并不是这样，它是完全按照模块的依赖树来分析，根据依赖进行打包。我们的组件之间如果没有依赖，是没法打到一起的。</p></li>

<li><p><strong>CommonsChunkPlugin的硬伤。</strong>  关于公用组件的处理，其实可以用CommonsChunkPlugin这个插件，它能自动分析出公共模块并打成一个包。但是这个插件有个硬伤，如果我写了一个名为popbox的组件，本意是想给项目公用，但是目前只有一个模块用到了它，那么插件并不能知道它是公用插件，而会把它和业务代码打包到一起。倘若将来有第二个模块用到了popbox，就又会把它打进公共包里，这显然是很弱智的行为。</p></li>

<li><p><strong>entry只干入口的事。</strong>  我一开始想，把公共组件放entry中打包一下行不行，像这样配置：<code>components: ['loading', 'menu', 'box']</code>。结果证明是不能的，文件虽然能打包出来，但是没法用，就是你<code>&lt;script&gt;</code>标签把文件加到页面也不行，别的模块用require无法引用到。原因就是entry打包出的文件作为入口文件，必须包含直接运行的代码。</p></li>

<li><p><strong>webpack-stream是个鸡肋。</strong>  一开始我被entry和output的各种配置整的摸不着头脑，因为项目目录多，想要更精细的控制，却发现output总是无法按我的需求输出。后来我看到了有webpack-stream这个东西，而且是官方推荐的。简单来讲，它就是实现了文件流接口，从而能与gulp配合工作，我一看这是个好东西啊。研究了一番，发现也没什么功能，就是能用gulp.src代替entry，用gulp.dest代替output，对于多入口打包，就完全没什么用了，还得在webpack中配置，所以简直就是个鸡肋。直接弃用。</p></li>

<li><p><strong>这么多require用哪个。</strong>  一开始用webpack构建应用的时候，每当写require的时候我是懵逼的，有commonjs风格的require用法、AMD风格的require加回调用法，以及webpack提供的require.ensure用来打包异步加载的模块。另外还有ES6的import，既然都用vue了，我们肯定得用ES6嘛。这么多引入模块的方法，你得保持头脑清醒了，他们都有什么区别，什么场景下用哪个。</p></li>

<li><p><strong>dist目录不是给人看的。</strong>  鉴于之前用gulp的习惯，打包后的目录也是有很清晰的结构，而且打包前我们src目录下的代码也是直接可运行的。但是有了webpack之后，首先src下的代码未经打包不能在开发环境运行，其次output选项只能指定一个输出目录，无法再按你的想法再进行组织。唯一有点用的方法是在entry中，把入口文件名字写成这样foo/bar/baz。勉强能在输出目录中新建出文件夹。但是总体来看，dist目录还是一团糟，尤其是异步的chunk文件，只能是id+hash这样的名字。所以我也明白了，要用webpack就别打算去看dist目录了，只能用sourcemap在浏览器看。</p></li>
</ol>

    
        

<h2 id="core-features-of-es2015-es6">Core Features of ES2015 (ES6)</h2>

<p><span style="color:#999">Note on Adrain Mejia&rsquo;s article</span></p>

<h3 id="history">History</h3>

<p>ES6, a.k.a. ES2015+, ECMAScript6.</p>

<p>Javascript is evolving since it was created, and ES6 is now well supported in all modern browsers.</p>

<p><img src="http://www.itnose.net/img/20161122/196231.png" alt="" />
<img src="http://www.itnose.net/img/20161122/196240.png" alt="" />
(<a href="https://kangax.github.io/compat-table/es6/">compatibility ref</a>)</p>

<h3 id="es6-core-features">ES6 core features</h3>

<h4 id="block-scoped-variables">block-scoped variables</h4>

<p>We know that <em>var</em> is not block-scoped, but function scoped.
In ES6, <em>let</em> and <em>const</em> is used instead of <em>var</em> to limit variable scoped to block.
<strong><em>let</em> is the better <em>var</em></strong>
A variable must be defined before use when it&rsquo;s defined by <em>let</em>, and it exists only inside its block, like a for-loop or if-block.</p>

<h4 id="hoist">Hoist</h4>

<pre><code>var x = 'outer';
function test(inner) {
  if (inner) {
    var x = 'inner';
    return x;
  }
  return x;
}
test(false);
// &lt;- undefined
</code></pre>

<p>Using <em>var</em>, even the <code>if</code> clause was not executed, the <code>x</code> inside it was hoisted. But only the declaration was hoisted, not the initialization.</p>

<h4 id="temporal-dead-zone">Temporal Dead-zone</h4>

<p>In ES6, <em>let</em> hoists a variable to the top of the block, and from the top on the block to the <em>let</em> declaration is a &ldquo;temporal dead zone&rdquo;, where a variable is not usable (ReferenceError).</p>

<h4 id="no-more-iife">No more IIFE</h4>

<p>We all familiar with IIFE (Immediately-Invoked Function Expression), and write it everyday. Because without IIFE, the function names and variables will pollute everywhere.</p>

<pre><code>(function() {
  var bar = 'ES5';
  function foo() {}
}());
</code></pre>

<p>With <em>let</em> grammar, IIFE is not essential anymore.</p>

<pre><code>{
  let bar = 'ES6';
  let foo = () =&gt; {};
}
</code></pre>

<h4 id="const">const</h4>

<p>When a re-assignation is necessary, ust <em>let</em>.
When the value of a variable should not be changable, use <em>const</em>.</p>

<pre><code>const _version = '0.1';
</code></pre>

<h4 id="text-template">Text Template</h4>

<pre><code>// ES5
var firstName = 'Adrian';
var lastName = 'Mejia';
console.log('Your name is ' + firstName + ' ' + lastName + '.');
</code></pre>

<p>Now <em>`</em> and <em>${}</em> is available.</p>

<pre><code>// ES6
const firstName = 'Adrian';
const lastName = 'Mejia';
console.log(`Your name is ${firstName} ${lastName}`);
</code></pre>

<h4 id="multi-line-string">Multi-line String</h4>

<pre><code>// ES5
var template = '&lt;li *ngFor=&quot;let todo of todos&quot; [ngClass]=&quot;{completed: todo.isDone}&quot; &gt;n' +
'  &lt;div class=&quot;view&quot;&gt;n' +
'    &lt;input class=&quot;toggle&quot; type=&quot;checkbox&quot; [checked]=&quot;todo.isDone&quot;&gt;n' +
'    &lt;label&gt;&lt;/label&gt;n' +
'    &lt;button class=&quot;destroy&quot;&gt;&lt;/button&gt;n' +
'  &lt;/div&gt;n' +
'  &lt;input class=&quot;edit&quot; value=&quot;&quot;&gt;n' +
'&lt;/li&gt;';
console.log(template);
</code></pre>

<p>Just using <em>`</em>, you can write multiple string directly.</p>

<pre><code>// ES6
const template = `&lt;li *ngFor=&quot;let todo of todos&quot; [ngClass]=&quot;{completed: todo.isDone}&quot; &gt;
  &lt;div class=&quot;view&quot;&gt;
    &lt;input class=&quot;toggle&quot; type=&quot;checkbox&quot; [checked]=&quot;todo.isDone&quot;&gt;
    &lt;label&gt;&lt;/label&gt;
    &lt;button class=&quot;destroy&quot;&gt;&lt;/button&gt;
  &lt;/div&gt;
  &lt;input class=&quot;edit&quot; value=&quot;&quot;&gt;
&lt;/li&gt;`;
console.log(template);
</code></pre>

<h4 id="deconstruction-and-assignment">Deconstruction and Assignment</h4>

<p>Get array elements.</p>

<pre><code>// ES5
var array = [1, 2, 3, 4];
var first = array[0];
var third = array[2];
console.log(first, third); // 1 3
</code></pre>

<pre><code>// ES6
const array = [1, 2, 3, 4];
const [first, ,third] = array;
console.log(first, third); // 1 3
</code></pre>

<p>Switch values.</p>

<pre><code>// ES5
var a = 1;
var b = 2;
var tmp = a;
a = b;
b = tmp;
console.log(a, b); // 2 1
</code></pre>

<pre><code>// ES6
let a = 1;
let b = 2;
[a, b] = [b, a];
console.log(a, b); // 2 1
</code></pre>

<p>Return multiple value</p>

<pre><code>// ES5
function margin() {
  var left=1, right=2, top=3, bottom=4;
  return { left: left, right: right, top: top, bottom: bottom };
}
var data = margin();
var left = data.left;
var bottom = data.bottom;
console.log(left, bottom); // 1 4
</code></pre>

<pre><code>// ES6
function margin() {
  const left=1, right=2, top=3, bottom=4;
  return { left, right, top, bottom }; // grammar sugar {left:left} -&gt; {left}
}
const { left, bottom } = margin();
console.log(left, bottom); // 1 4
</code></pre>

<p>Parameter match</p>

<pre><code>// ES5
var user = {firstName: 'Adrian', lastName: 'Mejia'};
function getFullName(user) {
  var firstName = user.firstName;
  var lastName = user.lastName;
  return firstName + ' ' + lastName;
}
console.log(getFullName(user)); // Adrian Mejia
</code></pre>

<pre><code>// ES6
const user = {firstName: 'Adrian', lastName: 'Mejia'};
function getFullName({ firstName, lastName }) {
  return `${firstName} ${lastName}`;
}
console.log(getFullName(user)); // Adrian Mejia
</code></pre>

<p>Deep match</p>

<pre><code>// ES5
function settings() {
  return { display: { color: 'red' }, keyboard: { layout: 'querty'} };
}
var tmp = settings();
var displayColor = tmp.display.color;
var keyboardLayout = tmp.keyboard.layout;
console.log(displayColor, keyboardLayout); // red querty
</code></pre>

<pre><code>// ES6
function settings() {
  return { display: { color: 'red' }, keyboard: { layout: 'querty'} };
}
const { display: { color: displayColor }, keyboard: { layout: keyboardLayout }} = settings();
console.log(displayColor, keyboardLayout); // red querty
</code></pre>

<p>Deconstruction is useful, and helpful in forming a good coding style.
Use array deconstrunction to avoid temporary variables.
Use Object deconstrunction to deal with multiple return values.</p>

<h4 id="class-and-object">Class and Object</h4>

<pre><code>// ES5
var Animal = (function () {
  function MyConstructor(name) {
    this.name = name;
  }
  MyConstructor.prototype.speak = function speak() {
    console.log(this.name + ' makes a noise.');
  };
  return MyConstructor;
})();
var animal = new Animal('animal');
animal.speak(); // animal makes a noise.
</code></pre>

<p>ES6 provides grammar sugar to define a class object.
With <em>class</em>, <em>constructor</em>, you can define speak() instead of constructor.prototype.speak = function().
Use <em>class</em> and avoid deal with <em>prototype</em>. The same functionality, more elegant.</p>

<pre><code>// ES6
class Animal {
  constructor(name) {
    this.name = name;
  }
  speak() {
    console.log(this.name + ' makes a noise.');
  }
}
const animal = new Animal('animal');
animal.speak(); // animal makes a noise.
</code></pre>

<p>Avoid empty constructor. A class has a default constructor itself.</p>

<h4 id="inherit">Inherit</h4>

<p>Inheritance in ES5 is complex.</p>

<pre><code>// ES5
var Lion = (function () {
  function MyConstructor(name){
    Animal.call(this, name);
  }
  // prototypal inheritance
  MyConstructor.prototype = Object.create(Animal.prototype);
  MyConstructor.prototype.constructor = Animal;
  MyConstructor.prototype.speak = function speak() {
    Animal.prototype.speak.call(this);
    console.log(this.name + ' roars ');
  };
  return MyConstructor;
})();
var lion = new Lion('Simba');
lion.speak(); // Simba makes a noise.
// Simba roars.
</code></pre>

<pre><code>// ES6
class Lion extends Animal {
  speak() {
    super.speak();
    console.log(this.name + ' roars ');
  }
}
const lion = new Lion('Simba');
lion.speak(); // Simba makes a noise.
// Simba roars.
</code></pre>

<p>ES6 has <em>extends</em> and <em>super</em>, makes inheritance much clearer.</p>

<h4 id="promise">Promise</h4>

<p><em>promise</em> is used to eliminate the callback hell.</p>

<pre><code>// ES5
function printAfterTimeout(string, timeout, done){
  setTimeout(function(){
    done(string);
  }, timeout);
}
printAfterTimeout('Hello ', 2e3, function(result){
  console.log(result);
  // nested callback
  printAfterTimeout(result + 'Reader', 2e3, function(result){
    console.log(result);
  });
});
</code></pre>

<p>This function exec a callback after done(), twice. More layer of callbacks, it will become a mess.
With <em>promise</em>:</p>

<pre><code>// ES6
function printAfterTimeout(string, timeout){
  return new Promise((resolve, reject) =&gt; {
    setTimeout(function(){
      resolve(string);
    }, timeout);
  });
}
printAfterTimeout('Hello ', 2e3).then((result) =&gt; {
  console.log(result);
  return printAfterTimeout(result + 'Reader', 2e3);
}).then((result) =&gt; {
  console.log(result);
});
</code></pre>

<p>Use <em>promise</em>, another function can be called by <em>then</em> after a function is executed without nesting.</p>

<h4 id="arrow-function">Arrow Function</h4>

<p>In ES5, <em>this</em> point to the environment in which a function is executed, instead of in which it is defined.</p>

<pre><code>// ES5
var _this = this; // need to hold a reference
$('.btn').click(function(event){
  _this.sendData(); // reference outer this
});
$('.input').on('change',function(event){
  this.sendData(); // reference outer this
}.bind(this)); // bind to outer this
</code></pre>

<p>With <code>()=&gt;{}</code>, you don&rsquo;t need to use a temporary variable to hold <em>this</em> or use <em>bind</em>.</p>

<pre><code>// ES6
// this will reference the outer one
$('.btn').click((event) =&gt;  this.sendData());
// implicit returns
const ids = [291, 288, 984];
const messages = ids.map(value =&gt; `ID is ${value}`);
</code></pre>

<h4 id="for-of">for &hellip; of</h4>

<h4 id="default-value-of-function-arguments">default value of function arguments</h4>

<p>Just like in C, Python, and any other languages.</p>

<h4 id="remaining-arguments">&hellip; remaining arguments</h4>

<p>A <em>argumnets</em> like operation.</p>

<pre><code>function printf(format, ...params) {
  console.log('params: ', params);
  console.log('format: ', format);
}
printf('%s %d %.2f', 'adrian', 321, Math.PI);
</code></pre>

<h4 id="open-spread-operator-which-terminology">open/spread operator (??? which terminology)</h4>

<p>In ES5, apply()</p>

<pre><code>Math.max(2,100,1,6,43) // &lt;- 100
Math.max([2,100,1,6,43]) // &lt;- NaN
Math.max.apply(Math, [2,100,1,6,43]) // &lt;- 100
</code></pre>

<p>In ES6, just spread the array.</p>

<pre><code>Math.max(...[2,100,1,6,43]) // 100
</code></pre>

<p>In ES6, concat() arrays.</p>

<pre><code>var array1 = [2,100,1,6,43];
var array2 = ['a', 'b', 'c', 'd'];
var array3 = [false, true, null, undefined];
console.log(array1.concat(array2, array3));
</code></pre>

<p>ES6 spreads nested arrays.</p>

<pre><code>// ES6
const array1 = [2,100,1,6,43];
const array2 = ['a', 'b', 'c', 'd'];
const array3 = [false, true, null, undefined];
console.log([...array1, ...array2, ...array3]);
</code></pre>

<hr />

    
        

<h2 id="note-on-express-basic">Note on Express Basic</h2>

<h3 id="routing">Routing</h3>

<p>A route method is derived from one of the HTTP methods, and is attached to an instance of the express class.</p>

<h4 id="route-methods">Route methods</h4>

<p>Express supports the following routing methods that correspond to HTTP methods:
<code>get, post, put, head, delete, options, trace, copy, lock, mkcol, move, purge, propfind, proppatch, unlock, report, mkactivity, checkout, merge, m-search, notify, subscribe, unsubscribe, patch, search, and connect</code>.</p>

<p>To route methods that translate to invalid JavaScript variable names, use the bracket notation.
<code>app['m-search']('/', function(){})</code></p>

<p>An extra routing method <code>app.all()</code> is used for loading middleware functions at a path for all request methods.</p>

<pre><code>app.get('/', function(req, res) {
})
app.post('/', function(req, res) {
})
app.all('/', function(req, res, next) {
    ;
    next()
})
</code></pre>

<h4 id="route-paths">Route paths</h4>

<p>Route path supports string, string pattern with *? + * ()*, and regular expression.
In string, hyphen and dot are literal characters.</p>

<pre><code>app.get('/ab*c(de)?f', function(req, res) {})
app.get(/.*foo$/, function(req, res) {})
</code></pre>

<p><strong>Route parameters</strong></p>

<p>Express captures named URL segments into <em>req.params</em> object.
&gt; The name of route parameters must be made up of “word characters” ([A-Za-z0-9_]).</p>

<pre><code>Route path: /users/:userId/books/:bookId
Request URL: http://localhost:3000/users/34/books/8989
req.params: { &quot;userId&quot;: &quot;34&quot;, &quot;bookId&quot;: &quot;8989&quot; }

Route path: /flights/:from-:to
Request URL: http://localhost:3000/flights/LAX-SFO
req.params: { &quot;from&quot;: &quot;LAX&quot;, &quot;to&quot;: &quot;SFO&quot; }

Route path: /plantae/:genus.:species
Request URL: http://localhost:3000/plantae/Prunus.persica
req.params: { &quot;genus&quot;: &quot;Prunus&quot;, &quot;species&quot;: &quot;persica&quot; }
</code></pre>

<h4 id="route-handlers">Route handlers</h4>

<p>Route handlers are used to handle a request, and they&rsquo;re chained by <code>next()</code>.
You can use functions, and arrays of functions, and their mix.</p>

<pre><code>var cb0 = function (req, res, next) {
  console.log('CB0')
  next()
}

var cb1 = function (req, res, next) {
  console.log('CB1')
  next()
}

app.get('/example', [cb0, cb1], function (req, res, next) {
  console.log('the response will be sent by the next function ...')
  next()
}, function (req, res) {
  res.send('Hello from D!')
})
</code></pre>

<h4 id="response-methods">Response methods</h4>

<p>A response method sends a response to the client, and terminates the request-response cycle.
If no response method is called, the client request will be left hanging.</p>

<pre><code>- **Method**    **Description**
- res.download()    Prompt a file to be downloaded.
- res.end()         End the response process.
- res.json()        Send a JSON response.
- res.jsonp()       Send a JSON response with JSONP support.
- res.redirect()    Redirect a request.
- res.render()      Render a view template.
- res.send()        Send a response of various types.
- res.sendFile()    Send a file as an octet stream.
- res.sendStatus()  Set the response status code and send its string representation as the response body.
</code></pre>

<h4 id="app-route">app.route()</h4>

<p>It creates a handler-chain for a given route path.</p>

<pre><code>app.route('/book')
  .get(function (req, res) {
    res.send('Get a random book')
  })
  .post(function (req, res) {
    res.send('Add a book')
  })
  .put(function (req, res) {
    res.send('Update the book')
  })
</code></pre>

<h4 id="express-router">express.Router</h4>

<p>Use the express.Router class to create modular, mountable route handlers. A Router instance is a complete middleware and routing system; for this reason, it is often referred to as a “mini-app”.</p>

<p>The following example creates a router as a module, loads a middleware function in it, defines some routes, and mounts the router module on a path in the main app.</p>

<p>Create a router file named birds.js in the app directory, with the following content:</p>

<pre><code>var express = require('express')
var router = express.Router()

// middleware that is specific to this router
router.use(function timeLog (req, res, next) {
  console.log('Time: ', Date.now())
  next()
})
// define the home page route
router.get('/', function (req, res) {
  res.send('Birds home page')
})
// define the about route
router.get('/about', function (req, res) {
  res.send('About birds')
})

module.exports = router
</code></pre>

<p>Then, load the router module in the app:</p>

<pre><code>var birds = require('./birds')

// ...

app.use('/birds', birds)
</code></pre>

<p>The app will now be able to handle requests to /birds and /birds/about, as well as call the timeLog middleware function that is specific to the route.</p>

<hr />

    
        

<h2 id="mysql-in-nodejs">MySQL in NodeJS</h2>

<h3 id="1-建立数据库连接-createconnection-object">1. 建立数据库连接 createConnection(Object)</h3>

<p>该方法接受一个对象作为参数，该对象有四个常用的属性host，user，password，database。与php中链接数据库的参数相同。属性列表如下：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">host</span><span class="o">:</span> <span class="nx">连接数据库所在的主机名</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="nx">localhost</span><span class="p">)</span>
<span class="nx">port</span><span class="o">:</span> <span class="nx">连接端口</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="mi">3306</span><span class="p">)</span>
<span class="nx">localAddress</span><span class="o">:</span> <span class="nx">用于TCP连接的IP地址</span><span class="p">.</span> <span class="p">(</span><span class="nx">可选</span><span class="p">)</span>
<span class="nx">socketPath</span><span class="o">:</span> <span class="nx">链接到unix域的路径</span><span class="err">。</span><span class="nx">在使用host和port时该参数会被忽略</span><span class="p">.</span>
<span class="nx">user</span><span class="o">:</span> <span class="nx">MySQL用户的用户名</span><span class="p">.</span>
<span class="nx">password</span><span class="o">:</span> <span class="nx">MySQL用户的密码</span><span class="p">.</span>
<span class="nx">database</span><span class="o">:</span> <span class="nx">链接到的数据库名称</span> <span class="p">(</span><span class="nx">可选</span><span class="p">).</span>
<span class="nx">charset</span><span class="o">:</span> <span class="nx">连接的字符集</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="s1">&#39;UTF8_GENERAL_CI&#39;</span><span class="p">.</span><span class="nx">设置该值要使用大写</span><span class="o">!</span><span class="p">)</span>
<span class="nx">timezone</span><span class="o">:</span> <span class="nx">储存本地时间的时区</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
<span class="nx">stringifyObjects</span><span class="o">:</span> <span class="nx">是否序列化对象</span><span class="p">.</span> <span class="nx">See</span> <span class="nx">issue</span> <span class="err">#</span><span class="mf">501.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
<span class="nx">insecureAuth</span><span class="o">:</span> <span class="nx">是否允许旧的身份验证方法连接到数据库实例</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="nx">typeCast</span><span class="o">:</span> <span class="nx">确定是否讲column值转换为本地JavaScript类型列值</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="nx">queryFormat</span><span class="o">:</span> <span class="nx">自定义的查询语句格式化函数</span><span class="p">.</span>
<span class="nx">supportBigNumbers</span><span class="o">:</span> <span class="nx">数据库处理大数字</span><span class="p">(</span><span class="nx">长整型和含小数</span><span class="p">),</span><span class="nx">时应该启用</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="kc">false</span><span class="p">).</span>
<span class="nx">bigNumberStrings</span><span class="o">:</span> <span class="nx">启用</span> <span class="nx">supportBigNumbers和bigNumberStrings</span> <span class="nx">并强制这些数字以字符串的方式返回</span><span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="kc">false</span><span class="p">).</span> 
<span class="nx">dateStrings</span><span class="o">:</span> <span class="nx">强制日期类型</span><span class="p">(</span><span class="nx">TIMESTAMP</span><span class="p">,</span> <span class="nx">DATETIME</span><span class="p">,</span> <span class="nx">DATE</span><span class="p">)</span><span class="nx">以字符串返回</span><span class="err">，</span><span class="nx">而不是一javascript</span> <span class="nx">Date对象返回</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="nx">debug</span><span class="o">:</span> <span class="nx">是否开启调试</span><span class="p">.</span> <span class="p">(</span><span class="nx">默认</span><span class="o">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="nx">multipleStatements</span><span class="o">:</span> <span class="nx">是否允许在一个query中传递多个查询语句</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="nx">flags</span><span class="o">:</span> <span class="nx">链接标志</span><span class="p">.</span>
<span class="c1">// 还可以使用字符串连接数据库</span>
<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="s1">&#39;mysql://user:pass@host/db?debug=true&amp;charset=BIG5_CHINESE_CI&amp;timezone=-0700&#39;</span><span class="p">);</span>
</code></pre></div>

<h3 id="2-结束数据库连接-end-destroy">2 结束数据库连接 end() destroy()</h3>

<p>end()接受一个回调函数，并且会在query结束之后才触发，如果query出错，仍然会终止链接，错误会传递到回调函数中处理。</p>

<p>destroy()立即终止数据库连接，即使还有query没有完成，之后的回调函数也不会在触发。</p>

<h3 id="3-创建连接池-createpool-object">3. 创建连接池 createPool(Object)</h3>

<p>Object和createConnection参数相同
可以监听connection事件，并设置session值</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">pool</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>  
    <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SET SESSION auto_increment_increment=1&#39;</span><span class="p">)</span>  
<span class="p">});</span>
</code></pre></div>

<p>connection.release()释放链接到连接池。如果需要关闭连接并且删除，需要使用connection.destroy()<br />
pool除了接受和connection相同的参数外，还接受几个扩展的参数</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">createConnection</span><span class="o">:</span> <span class="nx">用于创建链接的函数</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">)</span>  
<span class="nx">waitForConnections</span><span class="o">:</span> <span class="nx">决定当没有连接池或者链接数打到最大值时pool的行为</span><span class="p">.</span> <span class="nx">为true时链接会被放入队列中在可用是调用</span><span class="err">，</span><span class="nx">为false时会立即返回error</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="kc">true</span><span class="p">)</span>  
<span class="nx">connectionLimit</span><span class="o">:</span> <span class="nx">最大连接数</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="mi">10</span><span class="p">)</span>  
<span class="nx">queueLimit</span><span class="o">:</span> <span class="nx">连接池中连接请求的烈的最大长度</span><span class="err">，</span><span class="nx">超过这个长度就会报错</span><span class="err">，</span><span class="nx">值为0时没有限制</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>  
</code></pre></div>

<h3 id="4-连接池集群">4. 连接池集群</h3>

<p>允许不同的host链接</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="c1">// create</span>
<span class="kd">var</span> <span class="nx">poolCluster</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPoolCluster</span><span class="p">();</span>

<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span> <span class="c1">// anonymous group</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;MASTER&#39;</span><span class="p">,</span> <span class="nx">masterConfig</span><span class="p">);</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;SLAVE1&#39;</span><span class="p">,</span> <span class="nx">slave1Config</span><span class="p">);</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;SLAVE2&#39;</span><span class="p">,</span> <span class="nx">slave2Config</span><span class="p">);</span>

<span class="c1">// Target Group : ALL(anonymous, MASTER, SLAVE1-2), Selector : round-robin(default)</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{});</span>

<span class="c1">// Target Group : MASTER, Selector : round-robin</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="s1">&#39;MASTER&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{});</span>

<span class="c1">// Target Group : SLAVE1-2, Selector : order</span>
<span class="c1">// If can&#39;t connect to SLAVE1, return SLAVE2. (remove SLAVE1 in the cluster)</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">nodeId</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;REMOVED NODE : &#39;</span> <span class="o">+</span> <span class="nx">nodeId</span><span class="p">);</span> <span class="c1">// nodeId = SLAVE1 </span>
<span class="p">});</span>

<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="s1">&#39;SLAVE*&#39;</span><span class="p">,</span> <span class="s1">&#39;ORDER&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{});</span>

<span class="c1">// of namespace : of(pattern, selector)</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{});</span>

<span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">poolCluster</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="s1">&#39;SLAVE*&#39;</span><span class="p">,</span> <span class="s1">&#39;RANDOM&#39;</span><span class="p">);</span>
<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{});</span>
<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{});</span>

<span class="c1">// destroy</span>
<span class="nx">poolCluster</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</code></pre></div>

<p>链接集群的可选参数</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">canRetry</span><span class="o">:</span> <span class="nx">值为true时</span><span class="err">，</span><span class="nx">允许连接失败时重试</span><span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="kc">true</span><span class="p">)</span>  
<span class="nx">removeNodeErrorCount</span><span class="o">:</span> <span class="nx">当连接失败时</span> <span class="nx">errorCount</span> <span class="nx">值会增加</span><span class="p">.</span> <span class="nx">当errorCount</span> <span class="nx">值大于</span> <span class="nx">removeNodeErrorCount</span> <span class="nx">将会从PoolCluster中删除一个节点</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="mi">5</span><span class="p">)</span>  
<span class="nx">defaultSelector</span><span class="o">:</span> <span class="nx">默认选择器</span><span class="p">.</span> <span class="p">(</span><span class="nx">Default</span><span class="o">:</span> <span class="nx">RR</span><span class="p">)</span>  
<span class="nx">RR</span><span class="o">:</span> <span class="nx">循环</span><span class="p">.</span> <span class="p">(</span><span class="nx">Round</span><span class="o">-</span><span class="nx">Robin</span><span class="p">)</span>  
<span class="nx">RANDOM</span><span class="o">:</span> <span class="nx">通过随机函数选择节点</span><span class="p">.</span>  
<span class="nx">ORDER</span><span class="o">:</span> <span class="nx">无条件地选择第一个可用节点</span><span class="p">.</span>  
</code></pre></div>

<h3 id="5-切换用户-改变连接状态">5. 切换用户 / 改变连接状态</h3>

<p>Mysql允许在比断开连接的的情况下切换用户</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">connection</span><span class="p">.</span><span class="nx">changeUser</span><span class="p">({</span><span class="nx">user</span> <span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>  
<span class="p">});</span>  
<span class="c1">// 参数  </span>
<span class="nx">user</span><span class="o">:</span> <span class="nx">新的用户</span> <span class="p">(</span><span class="nx">默认为早前的一个</span><span class="p">).</span>  
<span class="nx">password</span><span class="o">:</span> <span class="nx">新用户的新密码</span> <span class="p">(</span><span class="nx">默认为早前的一个</span><span class="p">).</span>  
<span class="nx">charset</span><span class="o">:</span> <span class="nx">新字符集</span> <span class="p">(</span><span class="nx">默认为早前的一个</span><span class="p">).</span>  
<span class="nx">database</span><span class="o">:</span> <span class="nx">新数据库名称</span> <span class="p">(</span><span class="nx">默认为早前的一个</span><span class="p">).</span>  
</code></pre></div>

<h3 id="6-处理服务器连接断开">6. 处理服务器连接断开</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">db_config</span> <span class="o">=</span> <span class="p">{</span>  
        <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>  
        <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>  
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>  
        <span class="nx">database</span><span class="o">:</span> <span class="s1">&#39;example&#39;</span>  
    <span class="p">};</span>  
  
<span class="kd">var</span> <span class="nx">connection</span><span class="p">;</span>  

<span class="kd">function</span> <span class="nx">handleDisconnect</span><span class="p">()</span> <span class="p">{</span>  
  <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(</span><span class="nx">db_config</span><span class="p">);</span> <span class="c1">// Recreate the connection, since  </span>
                                                  <span class="c1">// the old one cannot be reused.  </span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>              <span class="c1">// The server is either down  </span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>                                     <span class="c1">// or restarting (takes a while sometimes).  </span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error when connecting to db:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>  
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">handleDisconnect</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span> <span class="c1">// We introduce a delay before attempting to reconnect,  </span>
    <span class="p">}</span>                                     <span class="c1">// to avoid a hot loop, and to allow our node script to  </span>
  <span class="p">});</span>                                     <span class="c1">// process asynchronous requests in the meantime.  </span>
                                          <span class="c1">// If you&#39;re also serving http, display a 503 error.  </span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>  
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;db error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>  
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;PROTOCOL_CONNECTION_LOST&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Connection to the MySQL server is usually  </span>
      <span class="nx">handleDisconnect</span><span class="p">();</span>                         <span class="c1">// lost due to either server restart, or a  </span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                      <span class="c1">// connnection idle timeout (the wait_timeout  </span>
      <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>                                  <span class="c1">// server variable configures this)  </span>
    <span class="p">}</span>  
  <span class="p">});</span>  
<span class="p">}</span>  

<span class="nx">handleDisconnect</span><span class="p">();</span>  
</code></pre></div>

<h3 id="7-转义查询值">7. 转义查询值</h3>

<p>为了避免SQL注入攻击，需要转义用户提交的数据。可以使用connection.escape() 或者 pool.escape()</p>

<p>如</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="s1">&#39;some user provided value&#39;</span><span class="p">;</span>  
<span class="kd">var</span> <span class="nx">sql</span>    <span class="o">=</span> <span class="s1">&#39;SELECT * FROM users WHERE id = &#39;</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>  
<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// ...  </span>
<span class="p">});</span>  
<span class="nx">或者使用</span><span class="err">？</span><span class="nx">作为占位符</span>  
<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">userId</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// ...  </span>
<span class="p">});</span>  
<span class="nx">不同类型值的转换结果</span>  
<span class="nx">Numbers</span> <span class="nx">不变</span>  
<span class="nx">Booleans</span> <span class="nx">转换为字符串</span> <span class="s1">&#39;true&#39;</span> <span class="o">/</span> <span class="s1">&#39;false&#39;</span>   
<span class="nb">Date</span> <span class="nx">对象转换为字符串</span> <span class="s1">&#39;YYYY-mm-dd HH:ii:ss&#39;</span>  
<span class="nx">Buffers</span> <span class="nx">转换为是6进制字符串</span>  
<span class="nx">Strings</span> <span class="nx">不变</span>  
<span class="nx">Arrays</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="nx">转换为</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span>  
<span class="nx">嵌套数组</span> <span class="p">[[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]]</span> <span class="nx">转换为</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>  
<span class="nx">Objects</span> <span class="nx">转换为</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;val&#39;</span> <span class="nx">pairs</span><span class="p">.</span> <span class="nx">嵌套对象转换为字符串</span><span class="p">.</span>  
<span class="kc">undefined</span> <span class="o">/</span> <span class="kc">null</span> <span class="o">===&gt;</span> <span class="nx">NULL</span>  
<span class="kc">NaN</span> <span class="o">/</span> <span class="kc">Infinity</span> <span class="nx">不变</span><span class="p">.</span> <span class="nx">MySQL</span> <span class="nx">不支持这些值</span><span class="p">,</span>  <span class="nx">除非有工具支持</span><span class="err">，</span><span class="nx">否则插入这些值会引起错误</span><span class="p">.</span>  
<span class="nx">转换实例</span><span class="err">：</span>  
<span class="kd">var</span> <span class="nx">post</span>  <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Hello MySQL&#39;</span><span class="p">};</span>  
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;INSERT INTO posts SET ?&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// Neat!  </span>
<span class="p">});</span>  
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">sql</span><span class="p">);</span> <span class="c1">// INSERT INTO posts SET `id` = 1, `title` = &#39;Hello MySQL&#39;  </span>
<span class="nx">或者手动转换</span>  
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM posts WHERE title=&quot;</span> <span class="o">+</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="s2">&quot;Hello MySQL&quot;</span><span class="p">);</span>  

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span> <span class="c1">// SELECT * FROM posts WHERE title=&#39;Hello MySQL&#39;  </span>
</code></pre></div>

<h3 id="8-转换查询标识符">8. 转换查询标识符</h3>

<p>如果不能信任SQL标识符(数据库名、表名、列名)，可以使用转换方法mysql.escapeId(identifier)；</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">sorter</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span><span class="p">;</span>  
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM posts ORDER BY &#39;</span> <span class="o">+</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">escapeId</span><span class="p">(</span><span class="nx">sorter</span><span class="p">);</span>  

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span> <span class="c1">// SELECT * FROM posts ORDER BY `date`  </span>
<span class="nx">支持转义多个</span>  
<span class="kd">var</span> <span class="nx">sorter</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span><span class="p">;</span>  
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM posts ORDER BY &#39;</span> <span class="o">+</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">escapeId</span><span class="p">(</span><span class="s1">&#39;posts.&#39;</span> <span class="o">+</span> <span class="nx">sorter</span><span class="p">);</span>  

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span> <span class="c1">// SELECT * FROM posts ORDER BY `posts`.`date`  </span>
<span class="nx">可以使用</span><span class="o">??</span><span class="nx">作为标识符的占位符</span>  
<span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  
<span class="kd">var</span> <span class="nx">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">];</span>  
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SELECT ?? FROM ?? WHERE id = ?&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">columns</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>  
  <span class="c1">// ...  </span>
<span class="p">});</span>  
  
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">sql</span><span class="p">);</span> <span class="c1">// SELECT `username`, `email` FROM `users` WHERE id = 1  </span>
</code></pre></div>

<h3 id="9-准备查询">9. 准备查询</h3>

<p>可以使用mysql.format来准备查询语句，该函数会自动的选择合适的方法转义参数。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM ?? WHERE ?? = ?&quot;</span><span class="p">;</span>  
<span class="kd">var</span> <span class="nx">inserts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">];</span>  
<span class="nx">sql</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">inserts</span><span class="p">);</span>  
<span class="mi">10</span><span class="err">、</span><span class="nx">自定义格式化函数</span>  
<span class="nx">connection</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">queryFormat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">values</span><span class="p">)</span> <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>  
  <span class="k">return</span> <span class="nx">query</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\:(\w+)/g</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">txt</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>  
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>  
    <span class="p">}</span>  
    <span class="k">return</span> <span class="nx">txt</span><span class="p">;</span>  
  <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>  
<span class="p">};</span>  

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">&quot;UPDATE posts SET title = :title&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Hello MySQL&quot;</span> <span class="p">});</span>  
</code></pre></div>

<h3 id="11-获取插入行的id">11. 获取插入行的id</h3>

<p>当使用自增主键时获取插入行id，如：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;INSERT INTO posts SET ?&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>  

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span><span class="p">);</span>  
<span class="p">});</span>  
</code></pre></div>

<h3 id="12-流处理">12. 流处理</h3>

<p>有时你希望选择大量的行并且希望在数据到达时就处理他们，你就可以使用这个方法</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM posts&#39;</span><span class="p">);</span>  
<span class="nx">query</span>  
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>  
      <span class="c1">// Handle error, an &#39;end&#39; event will be emitted after this as well  </span>
    <span class="p">})</span>  
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>  
      <span class="c1">// the field packets for the rows to follow  </span>
    <span class="p">})</span>  
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>  
      <span class="c1">// Pausing the connnection is useful if your processing involves I/O  </span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>  
  
      <span class="nx">processRow</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  
        <span class="nx">connection</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>  
      <span class="p">});</span>  
    <span class="p">})</span>  
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  
      <span class="c1">// all rows have been received  </span>
    <span class="p">});</span>  
</code></pre></div>

<h3 id="13-多语句-混合查询">13. 多语句/混合查询</h3>

<p>因为混合查询容易被SQL注入攻击，默认是不允许的，可以使用var connection = mysql.createConnection({multipleStatements: true});开启该功能。
 混合查询实例：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SELECT 1; SELECT 2&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>  

  <span class="c1">// `results` is an array with one element for every statement in the query:  </span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="c1">// [{1: 1}]  </span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// [{2: 2}]  </span>
<span class="p">});</span>  

<span class="c1">// 同样可以使用流处理混合查询结果：</span>
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;SELECT 1; SELECT 2&#39;</span><span class="p">);</span>  
<span class="nx">query</span>  
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>  
      <span class="c1">// the fields for the result rows that follow  </span>
    <span class="p">})</span>  
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>  
      <span class="c1">// index refers to the statement this result belongs to (starts at 0)  </span>
    <span class="p">});</span>  
</code></pre></div>

<p>如果其中一个查询语句出错，Error对象会包含err.index指示错误语句的id，整个查询也会终止。
混合查询结果的流处理方式是做实验性的，不稳定。</p>

<h3 id="14-事务处理">14. 事务处理</h3>

<p>connection级别的简单事务处理</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="p">}</span>  
  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;INSERT INTO posts SET title=?&#39;</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>   
      <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>  
      <span class="p">});</span>  
    <span class="p">}</span>  

    <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="s1">&#39;Post &#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span> <span class="o">+</span> <span class="s1">&#39; added&#39;</span><span class="p">;</span>  

    <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;INSERT INTO log SET data=?&#39;</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>  
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>   
        <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  
          <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>  
        <span class="p">});</span>  
      <span class="p">}</span>    
      <span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>  
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>   
          <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>  
          <span class="p">});</span>  
        <span class="p">}</span>  
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;success!&#39;</span><span class="p">);</span>  
      <span class="p">});</span>  
    <span class="p">});</span>  
  <span class="p">});</span>  
<span class="p">});</span>  
</code></pre></div>

<h3 id="15-错误处理">15. 错误处理</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">string</span>  
<span class="nx">err</span><span class="p">.</span><span class="nx">fatal</span> <span class="p">=&gt;</span> <span class="kr">boolean</span>  
</code></pre></div>

    
        

<h2 id="object-oriented-programming-of-javascript">Object-Oriented Programming of Javascript</h2>

<p>notes of
<a href="http://www.ruanyifeng.com/blog/2010/05/object-oriented_javascript_encapsulation.html">1</a>
<a href="http://www.ruanyifeng.com/blog/2010/05/object-oriented_javascript_inheritance.html">2</a>
<a href="http://www.ruanyifeng.com/blog/2010/05/object-oriented_javascript_inheritance_continued.html">3</a></p>

<h3 id="js-的对象">JS 的对象</h3>

<p>JS 本身是基于对象的语言，在 JS 中所操作的基本都是对象。但在 ES2015 之前它又没有 class 的类。</p>

<p>如果要从原型对象生成实例对象，要把属性和方法封装到对象里。properties and methods</p>

<ul>
<li>对象实例</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">let</span> <span class="nx">record</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">nation</span><span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">};</span>
</code></pre></div>

<p>Schema 规格</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">let</span> <span class="nx">record1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Alpha&quot;</span><span class="p">,</span> <span class="nx">nation</span><span class="o">:</span> <span class="s2">&quot;China&quot;</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">record2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Beta, nation: &quot;</span><span class="nx">Denmark</span><span class="err">&quot;</span> <span class="p">};</span>
</code></pre></div>

<p>给对象赋予属性和方法</p>

<p>这可以看作最简单的封装，但原型和实例间并不存在内在联系。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Record</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">nation</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nx">nation</span><span class="o">:</span> <span class="nx">nation</span><span class="p">,</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">record1</span> <span class="o">=</span> <span class="nx">Record</span><span class="p">(</span><span class="s2">&quot;Alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;China&quot;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">record2</span> <span class="o">=</span> <span class="nx">Record</span><span class="p">(</span><span class="s2">&quot;Beta&quot;</span><span class="p">,</span> <span class="s2">&quot;Denmark&quot;</span><span class="p">);</span>
</code></pre></div>

<p>用函数调用返回对象方式可以在原型和实例间建立一定联系，但两个实例间没有内在联系。</p>

<ul>
<li>构造函数模式</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Record</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">nation</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nation</span> <span class="o">=</span> <span class="nx">nation</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">record1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Record</span><span class="p">(</span><span class="s2">&quot;Alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;China&quot;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">record2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Record</span><span class="p">(</span><span class="s2">&quot;Beta&quot;</span><span class="p">,</span> <span class="s2">&quot;Denmark&quot;</span><span class="p">);</span>
</code></pre></div>

<p>Javascript 提供了 Constructor 构造函数模式。构造函数是使用了 this 变量的普通函数，在使用 new 运算符生成实例时，this 会绑定到对象实例上，使 <code>foo.constructor == Foo</code>。JS 中的 instanceof 运算符可以验证原型与实例对象间的关系，<code>(foo instanceof Foo) == true</code>。</p>

<ul>
<li>原型模式 prototype</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Record</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">nation</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">nation</span> <span class="o">=</span> <span class="nx">nation</span><span class="p">;</span> <span class="p">}</span>
<span class="nx">Record</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">species</span> <span class="o">=</span> <span class="s2">&quot;human&quot;</span><span class="p">;</span>
<span class="nx">Record</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">greet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">record1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Record</span><span class="p">(</span><span class="s2">&quot;Alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;China&quot;</span><span class="p">);</span> <span class="c1">// with `species` and `greet()`</span>
<span class="kd">let</span> <span class="nx">record2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Record</span><span class="p">(</span><span class="s2">&quot;Beta&quot;</span><span class="p">,</span> <span class="s2">&quot;Denmark&quot;</span><span class="p">);</span>
</code></pre></div>

<p>构造函数模式的问题在于原型中的属性和方法在每个实例中都要创建。其中重复的内容就额外地占用的资源。JS 中每个构造函数都有 prototype 属性，指向另一个对象；所指向对象的属性和方法都被构造函数继承。</p>

<p>这样，不变的属性和方法可以直接定义在 prototype 对象上。在例子中，所有实例的 species 和 greet() 方法都指向相同的地址，即 prototype 对象。</p>

<p>JS 中有一些对应 prototype 模式的方法</p>

<ul>
<li><p><code>isPrototypeOf()</code> 判断 prototype 对象和实例间的关系<br />
<code>Record.prototype.isPrototypeOf(record1)</code></p></li>

<li><p><code>hasOwnProperty()</code> 由实例判断一个属性是本地的还是继承的<br />
<code>record1.hasOwnProperty(&quot;name&quot;) == true</code><br />
<code>record1.hasOwnProperty(&quot;species&quot;) == false</code></p></li>

<li><p><code>in</code> 可以遍历一个对象的所有属性，或一个实例是否含有某个属性<br />
<code>for (let prop in record) console.log(prop);</code><br />
<code>&quot;name&quot; in record1 == true</code></p></li>
</ul>

<h3 id="继承对象">继承对象</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Record</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;Record&quot;</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">Personnel</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">dept</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">dept</span> <span class="o">=</span> <span class="nx">dept</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>

<p>对象间继承的方法。</p>

<ul>
<li><p>绑定构造函数<br />
使用 apply / call 将父对象的构造函数绑定到子对象上。子对象中需要显式地加入绑定语句。<br />
<code>function Personnel(name, dept) { ...; Record.apply(this, arguments); }</code></p></li>

<li><p>prototype<br />
将子类的 prototype 指向父类的一个实例，使所有子类实例继承父类。<br />
<code>Personnel.prototype = new Record();</code><br />
<code>Personnel.prototype.constructor = Personnel;</code><br />
首先是将 Personnel.prototype 替换为指向 Record实例。这时 Personnel.prototype.constructor 指向了 Record 的构造函数，即 <code>Personnel.prototype.constructor == Record</code>，由 Personnel 创建的实例也是如此。所以要将 Personnel.prototype 重新指向 Personnel 的构造函数。</p></li>

<li><p>继承 prototype<br />
JS 的函数对象可以将不变属性放在 prototype 中，对于只使用不变量的子类，可以直接继承父类的 prototype。<br />
<code>function Record() {}</code><br />
<code>Record.prototype.title = &quot;Record&quot;;</code><br />
<code>Personnel.prototype = Record.prototype;</code><br />
<code>Personnel.prototype.constructor = Personnel;</code><br />
这种方法不需要创建父类的实例，效率更高一些。<br />
直接继承 prototype 有一个问题，子类和父类的 prototype 指向了同一个对象，对子类 prototype 的修改会影响父类的 prototype。<br />
<code>Record.prototype.constructor == Personnel;</code></p></li>

<li><p>via 空对象<br />
利用空对象占用内存空间较小这点，通过空对象实例完成继承。
<code>let F = function() {};</code><br />
<code>F.prototype = Record.prototype;</code><br />
<code>Personnel.prototype = new F();</code><br />
<code>Personnel.prototype.constructor = Personnel;</code></p></li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="c1">// YUI extend function</span>
<span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">Child</span><span class="p">,</span> <span class="nx">Parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">F</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
    <span class="nx">F</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
    <span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">F</span><span class="p">();</span>
    <span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Child</span><span class="p">;</span>
    <span class="nx">Child</span><span class="p">.</span><span class="nx">uber</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">extend</span><span class="p">(</span><span class="nx">Personnel</span><span class="p">,</span> <span class="nx">Record</span><span class="p">);</span>
</code></pre></div>

<p>可以对这个方式进行封装。如 YUI 库实现继承的方法。</p>

<ul>
<li>copy<br />
就是将所有父类的属性和方法在子类中复制一份。</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Record</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">Record</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;Record&quot;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">Child</span><span class="p">,</span> <span class="nx">Parent</span><span class="p">)</span> 
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span>
        <span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uber</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr />

<h3 id="一般对象继承">一般对象继承</h3>

<p>无构造函数的普通对象的继承。
<code>let Record = {title: &quot;Record&quot;};</code></p>

<ul>
<li>通过 object 函数</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">object</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">F</span><span class="p">()</span> <span class="p">{}</span>
    <span class="nx">F</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">F</span><span class="p">();</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">Personnel</span> <span class="o">=</span> <span class="nx">object</span><span class="p">(</span><span class="nx">Record</span><span class="p">);</span>
</code></pre></div>

<ul>
<li>浅复制</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">uber</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">Personnel</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">Record</span><span class="p">);</span>
</code></pre></div>

<p>浅复制在父对象的成员也是对象时，会把对象地址复制给子类，造成子类可以修改父类。</p>

<ul>
<li>深复制</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">deepCopy</span><span class="p">(</span><span class="nx">Parent</span><span class="p">,</span> <span class="nx">Child</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">Child</span> <span class="o">=</span> <span class="nx">Child</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">Parent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Parent</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Child</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Parent</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nb">Array</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="p">{};</span>
            <span class="nx">deepCopy</span><span class="p">(</span><span class="nx">Parent</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">Child</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">Child</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">Child</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

    
        

<h2 id="practice-of-javascript-performance">Practice of JavaScript Performance</h2>

<p>Since JavaScript becomes a fullstack programming language, in certain cases the performance of JS is critical. Here are some practice of JS, with some understanding of JS implementation.</p>

<h3 id="data-store">Data Store</h3>

<p>How a variable is create will effect its performance.
- Use <em>{}</em> instead of <em>new Object</em>, use <em>[]</em> instead of new Array, use plain string instead of an object.
- Use local temporary variable to store variable deep upon the data-chain, and values require many calculation.
- dot-present has a similar performance as member operator, and it&rsquo;s faster in Safari. object.name vs object[name], object.name is always faster.</p>

<h3 id="loop">Loop</h3>

<p>In Chromium v54, <code>for-in</code> is slower, and <code>for (var i = 0; i &lt; length; ++i)</code>, <code>[].forEach(()=&gt;{})</code> have similar performance. forEach is much faster than it was in earlier browser.</p>

<h3 id="event-delegate">Event Delegate</h3>

<p>It will cause too much loads and occupy too many memory binding the same event to massive elements in the page.
It better to bind event to the outer layer, and deal with all events of its child elements.</p>

<pre><code>document.getElementById('content').addEventListener('click', function(evt) {
    evt = evt || window.event;
    let target = evt.target || evt.srcElement;
    if (target.nodeName.toLowerCase() !== 'a')
        return;
    console.log(target.href);
});
</code></pre>

<h3 id="re-render">Re-Render</h3>

<p>The source files create 2 trees in browser: DOM tree and Render tree.
Render tree deal with DOM geometry attributions. When the style of DOM changes, browser re-render the DOM.</p>

<pre><code>bodystyle = document.body.style; 
bodystyle.color = red; 
bodystyle.height = 1000px; 
bodystyke.width = 100%;
</code></pre>

<p>Three times of modification will cause 3 re-renders. Under certain circumstances, reduce the times of modification will improve rendering performance.</p>

<pre><code>bodystyle = document.body.style; 
bodystyle.cssText 'color:red;height:1000px;width:100%';
</code></pre>

<h3 id="javascript-load">JavaScript Load</h3>

<p>&lt;script&gt; tag might block something from downloading, so it&rsquo;s a good practice to put more script tag at the bottom of DOM, to avoid the time of empty page displayed to users.</p>

<h3 id="javascript-deployment">JavaScript Deployment</h3>

<p>Reduce the number of requirements and the file sizes will accelerate the page loading speed.
For example, use <em>webpack</em> and <em>uglify</em>.</p>

<h3 id="cache-js-files">Cache JS Files</h3>

<p>Cached files will improve the speed of page loading. Web servers use &ldquo;Expires HTTP Resonse Header&rdquo; to tell browser how long a resource should be cached. To avoid the problem of using old version of file, you can change the filename of static resource, like bundle-201612242359.js, using a timestamp to force browser to load the new js file.</p>

    
        

<h2 id="an-introduction-to-webpack">An Introduction to Webpack</h2>

<p><strong>Webpack</strong> is a bundler for javascript, and related resources.
All resources are treated as modules, and with various <em>loaders</em>,
webpack can handle modules of CommonJs, AMD, ES6, CSS, Image, JSON, Coffeescript, LESS, etc.</p>

<pre><code>// what a webpack config file 'webpack.config.js' looks like
module: {
  loaders: [
    { test: /\.css$/, loader: 'style!css' }, // use ! to chain loaders
    { test: /\.js$/, loader: 'jsx?harmony!babel', exclude: /node_modules/ }
    // loaders can be written like 'jsx-loader' or 'jsx'
    // loaders can take parameters as a querystring
  ]
}
</code></pre>

<p>Entrance and output.</p>

<pre><code>// webpack.config.js
module.exports = {
  entry: './entry.js',
  output: {
    filename: 'bundle.js'
  }
};
</code></pre>

<p>Filename extensions.</p>

<pre><code>// webpack.config.js
module.exports = {
  entry: 'entry.js',
  output: {
    filename: 'bundle.js'
  },
  resolve: {
    extensions: ['', '.js]
    // require('./foo') will search module with filename './foo' and './foo.js'
  }
}
</code></pre>

<h3 id="require-a-module">require a module</h3>

<pre><code>require('foo') // from module directory
require('./bar') // from relative path

define (require, exports.module) -&gt;
  require('foo')
  require('./bar)
</code></pre>

<h4 id="module-shim">module shim</h4>

<p>To require modules from <code>window</code>, you might need <code>expose-loader</code>.
Take jQuery for example</p>

<pre><code>{ test: require.resolve('jquery'), loader: 'expose?jQuery' }
</code></pre>

<h3 id="css-and-image">CSS and Image</h3>

<p>Write loader and require them as normal modules.</p>

<pre><code>// webpack.config.js
module.exports = {
  entry: 'entry.js',
  output: {
    path: './build', // for output processed images and resources
    publicPath: 'http://mycdn.com/', // for generate URLs to resources
    filename: 'bundle.js'
  },
  module: {
    loaders: [
      { test: /\.js$/, loader: 'jsx?harmony!babel', exclude: /node_modules/ }
      { test: /\.css$/, loader: 'style!css },
      { test: /\.less$/, loader: 'style!css!less },
      { test: /\.(png|jpg)$/, loader: 'url?limit=8192' }
      // inline base64 URLs for &lt;=8k images, direct URLs for the rest
    ]
  }
};
</code></pre>

<pre><code>require('./bootstrap.css');
require('./style.less');

let img = document.createElement('img');
img.src = require('./logo.png');
</code></pre>

<h3 id="multi-package-and-shared-package">Multi-package and shared package</h3>

<p>Shared packages are handled by <code>commonsPlugin</code>.</p>

<pre><code>var CommonsChunkPlugin = require(&quot;webpack/lib/optimize/CommonsChunkPlugin&quot;);
module.exports = {
    entry: {
        p1: &quot;./page1&quot;,
        p2: &quot;./page2&quot;,
        p3: &quot;./page3&quot;
    },
    output: {
        filename: &quot;[name].entry.chunk.js&quot;
    },
    plugins: [
        new CommonsChunkPlugin(&quot;commons.chunk.js&quot;)
    ]
}
</code></pre>

<h3 id="separated-css-package-http-webpack-github-io-docs-stylesheets-html-separate-css-bundle"><a href="http://webpack.github.io/docs/stylesheets.html#separate-css-bundle">Separated CSS package</a></h3>

<h3 id="hash-js-files">Hash js files</h3>

<p><em>One hash for the bundle</em>
<code>webpack ./entry output.[hash].bundle.js</code></p>

<pre><code>{
    output: {
        path: path.join(__dirname, &quot;assets&quot;, &quot;[hash]&quot;),
        publicPath: &quot;assets/[hash]/&quot;,
        filename: &quot;output.[hash].bundle.js&quot;,
        chunkFilename: &quot;[id].[hash].bundle.js&quot;
    }
}
</code></pre>

<p><em>One hash per chunk</em> <code>--output-chunk-file [chunkhash].js</code></p>

<pre><code>output: { chunkFilename: &quot;[chunkhash].bundle.js&quot; }
</code></pre>

<p><em>Get filenames from stats</em></p>

<pre><code>plugins: [
  function() {
    this.plugin(&quot;done&quot;, function(stats) {
      require(&quot;fs&quot;).writeFileSync(
        path.join(__dirname, &quot;..&quot;, &quot;stats.json&quot;),
        JSON.stringify(stats.toJson()));
    });
  }
]
</code></pre>

<h3 id="options-for-product">Options for Product</h3>

<p>You can specify a different config file for product-level bundling.
<code>webpack --config webpack.min.js</code></p>

<p>Compress the code. Loaders are switched into minimizing mode.
<a href="http://webpack.github.io/docs/list-of-plugins.html#uglifyjsplugin">Uglify</a></p>

<pre><code>plugins: [
   new webpack.optimize.MinChunkSizePlugin(minSize)
]
</code></pre>

<pre><code>new webpack.optimize.UglifyJsPlugin([options])
// e.g.
new webpack.optimize.UglifyJsPlugin({
    compress: {
        warnings: false
    }
})
</code></pre>

<p>You can/should use normal npm React package instead of the precompiled library.
Webpack can compress it to smaller size than react.min.js.</p>

<pre><code>new webpack.DefinePlugin({
  &quot;process.env&quot;: {
    NODE_ENV: JSON.stringify(&quot;production&quot;)
  }
})
</code></pre>

<h4 id="hot-replace">Hot Replace</h4>

<p>Include <code>webpack/hot/dev-server</code> in your project code, edit config file.</p>

<pre><code>  entry: {
    main: ['webpack/hot/dev-server', './entry],
  },
</code></pre>

<p>Then start the server, and visit it at [<a href="http://localhost:8080/webpack-dev-server/">http://localhost:8080/webpack-dev-server/</a>].</p>

<pre><code>webpack-dev-server --hot --quiet
</code></pre>

<p>And there is a <a href="http://gaearon.github.io/react-hot-loader/getstarted/"><strong>react-hot-loader</strong></a>.</p>

<pre><code>entry: [
  'webpack-dev-server/client?http://0.0.0.0:8080', // WebpackDevServer host and port
  'webpack/hot/only-dev-server',
  './scripts/index' // Your appʼs entry point
]
</code></pre>

<p>As for <code>only-dev-server</code>, the issue is replied <a href="https://github.com/gaearon/react-hot-loader/issues/73#issuecomment-73679446">here</a>.</p>

<h3 id="miscellaneous">Miscellaneous</h3>

<p>When webpack reports an error, but you cannot find out what&rsquo;s wrong, try this.</p>

<pre><code>webpack --display-error-details
</code></pre>

<hr />

<p>[Webpack list of loaders] <a href="http://webpack.github.io/docs/list-of-loaders.html">http://webpack.github.io/docs/list-of-loaders.html</a>
<a href="https://github.com/webpack/docs/wiki/optimization#multi-page-app">optimization</a>
[long term caching]<a href="http://webpack.github.io/docs/long-term-caching.html">http://webpack.github.io/docs/long-term-caching.html</a></p>

    
        

<h2 id="another-webpack-note">Another Webpack Note</h2>

<p><code>
其实Webpack的入门指导文章非常多，配置方式也各有各样，这里我推荐题叶大神的入门级指南–Webpack 入门指迷，如果不知道Webpack是什么或者不是很清楚各项配置含义的开发者，可以看此文章扫扫盲。毕竟我这篇文章并不是特别基础。
</code></p>

<h3 id="1-base-js">1. base.js</h3>

<p>var path = require(&lsquo;path&rsquo;)
var baseConfig = {
    resolve: {
        extensions: [&ldquo;, &lsquo;.js&rsquo;],
        fallback: [path.join(<strong>dirname, &lsquo;../node_modules&rsquo;)],
        alias: {
            &lsquo;src&rsquo;: path.resolve(</strong>dirname, &lsquo;../src&rsquo;),
            &lsquo;assets&rsquo;: path.resolve(<strong>dirname, &lsquo;../src/assets&rsquo;),
            &lsquo;components&rsquo;: path.resolve(</strong>dirname, &lsquo;../src/components&rsquo;)
        }
    },
    module: {
        loaders: [{
            test: /.js$/,
            loader: &lsquo;babel&rsquo;,
            exclude: /node_modules/
        }, {
            test: /.(png|jpe?g|gif|svg|woff2?|eot|ttf|otf)(\?.*)?$/,
            loader: &lsquo;url?limit=8192&amp;context=client&amp;name=[path][name].[hash:7].[ext]&rsquo;
        },
        {
            test: /.css$/,
            loader: &lsquo;style!css!autoprefixer&rsquo;,
        },
        {
            test: /.scss$/,
            loader: &lsquo;style!css!autoprefixer!sass&rsquo;
        }]
    }
};</p>

<p>module.exports = baseConfig;</p>

<p>`
解读下这个基本配置：</p>

<p>1、resolve 解析模块依赖的时候，受影响的配置项。</p>

<p>extensions 决定了哪些文件后缀在引用的时候可以省略点，Webpack帮助你补全名称。
fallback 当webpack在 root（默认当前文件夹，配置时要绝对路径） 和 modulesDirectories（默认当前文件夹，相对路径）配置下面找不到相关modules，去哪个文件夹下找modules
alias 这个大家应该比较熟悉，requirejs之类的都有，就是别名，帮助你快速指向文件路径，少写不少代码，而且不用关心层级关系，需要注意的是：在scss之类的css预编译中引用要加上~，以便于让loader识别是别名引用路径。</p>

<p>2、module 解析不同文件使用哪些loader，这个比较简单，很多文章都有，就不多说了，注意的是，这里的scss可以换成你自己的预编译器，例如：sass、less、stylus等，或者直接用postcss都行，当然还可以用一种通用方法，后面补上。
`</p>

<h3 id="2-开发环境配置-config">2. 开发环境配置 config</h3>

<p>var webpack = require(&lsquo;webpack&rsquo;);
var path = require(&lsquo;path&rsquo;)
var merge = require(&lsquo;webpack-merge&rsquo;)
var baseConfig = require(&lsquo;./webpack.base&rsquo;)
var getEntries = require(&lsquo;./getEntries&rsquo;)</p>

<p>var hotMiddlewareScript = &lsquo;webpack-hot-middleware/client?reload=true&rsquo;;</p>

<p>var assetsInsert = require(&lsquo;./assetsInsert&rsquo;)</p>

<p>module.exports = merge(baseConfig, {
  entry: getEntries(hotMiddlewareScript),
  devtool: &lsquo;#eval-source-map&rsquo;,
  output: {
    filename: &lsquo;./[name].[hash].js&rsquo;,
    path: path.resolve(&lsquo;./dist&rsquo;),
    publicPath:&lsquo;./dist&rsquo;
  },
  plugins: [
    new webpack.DefinePlugin({
      &lsquo;process.env&rsquo;: {
        NODE_ENV: &lsquo;&ldquo;development&rdquo;&rsquo;
      }
    }),
    new webpack.optimize.OccurenceOrderPlugin(),
    new webpack.HotModuleReplacementPlugin(),
    new webpack.NoErrorsPlugin(),
    new assetsInsert()
  ]
})</p>

<p>`
说说这个配置中的一些难点：</p>

<p>1、getEntries 是用来配置入口文件，一般很多人是自己手写，或者SPA页面，只有一个入口， 很容易就写出来，但是公司中，很多情况，是需要多入口，也就是多路由的Url，这个时候入口的配置就比较麻烦，我这里是放单独一个文件里面配置，我们公司是靠规定来执行，也就是一个文件夹所有的main.js都认为是入口文件，其他都忽略。
`</p>

<p>function getEntry(hotMiddlewareScript) {
    var pattern = paths.dev.js + &lsquo;project/**/main.js&rsquo;;
    var array = glob.sync(pattern);
    var newObj = {};</p>

<pre><code>array.map(function(el){
    var reg = new RegExp('project/(.*)/main.js','g');
    reg.test(el);
    if (hotMiddlewareScript) {
        newObj[RegExp.$1] = [el, hotMiddlewareScript];
    } else {
        newObj[RegExp.$1] = el;
    }
});
return newObj;
</code></pre>

<p>}</p>

<p><code>
2、assetsInsert 是用来做模板替换的，一个小插件把template里面的值替换成打包后的css或者js。
</code></p>

<h3 id="3-打包环境配置-production">3. 打包环境配置 production</h3>

<p>var webpack = require(&lsquo;webpack&rsquo;);
var path = require(&lsquo;path&rsquo;)
var merge = require(&lsquo;webpack-merge&rsquo;)
var baseConfig = require(&lsquo;./webpack.base&rsquo;)
var getEntries = require(&lsquo;./getEntries&rsquo;)
var ExtractTextPlugin = require(&lsquo;extract-text-webpack-plugin&rsquo;);
var assetsInsert = require(&lsquo;./assetsInsert&rsquo;)</p>

<p>var productionConf = merge(baseConfig, {
    entry: getEntries(),
    output: {
        filename: &lsquo;./[name].[hash].js&rsquo;,
        path: path.resolve(&lsquo;./public/dist&rsquo;),
        publicPath: &lsquo;./&rsquo;
    },
    plugins: [
        new webpack.DefinePlugin({
            &lsquo;process.env&rsquo;: {
                NODE_ENV: &lsquo;&ldquo;production&rdquo;&rsquo;
            }
        }),
        new ExtractTextPlugin(&lsquo;./[name].[hash].css&rsquo;, {
            allChunks: true
        }),
        new webpack.optimize.UglifyJsPlugin({
            compress: {
                warnings: false
            }
        }),
        new webpack.optimize.OccurenceOrderPlugin(),
        new assetsInsert()
    ]
})</p>

<p>productionConf.module.loaders = [
             {
                test: /.js$/,
                loader: &lsquo;babel&rsquo;,
                exclude: /node_modules/
            }, {
                test: /.(png|jpe?g|gif|svg|woff2?|eot|ttf|otf)(\?.*)?$/,
                loader: &lsquo;url?limit=8192&amp;context=client&amp;name=[path][name].[hash:7].[ext]&rsquo;
            },
            {
                test: /.css$/,
                loader: ExtractTextPlugin.extract(&lsquo;style&rsquo;, &lsquo;css&rsquo;),
            },
            {
                test: /.scss$/,
                loader: ExtractTextPlugin.extract(&lsquo;style&rsquo;, &lsquo;css!sass&rsquo;)
            }]</p>

<p>module.exports = productionConf</p>

<p>`
基本跟开发的差不多，差别在于：</p>

<p>1、使用ExtractTextPlugin 来打包css，所以要干掉原来base的loaders，重新写了一个，在最下面。</p>

<p>2、UglifyJsPlugin 给js压缩代码。其他没有什么好解释的了，一样的。
`</p>

<h3 id="4-构建命令">4. 构建命令</h3>

<p>require(&lsquo;shelljs/global&rsquo;)
env.NODE_ENV = &lsquo;production&rsquo;
var ora = require(&lsquo;ora&rsquo;)
var webpack = require(&lsquo;webpack&rsquo;)
var webpackConfig = require(&lsquo;./webpack.production.config&rsquo;)</p>

<p>var spinner = ora(&lsquo;building for production&hellip;&rsquo;)
spinner.start()</p>

<p>var staticPath = __dirname + &lsquo;/../public/dist/&rsquo;
rm(&lsquo;-rf&rsquo;, staticPath)
mkdir(&lsquo;-p&rsquo;, staticPath)</p>

<p>webpack(webpackConfig, function (err, stats) {
  spinner.stop()
  if (err) throw err
  process.stdout.write(stats.toString({
    colors: true,
    modules: false,
    children: false,
    chunks: false,
    chunkModules: false
  }) + &lsquo;\n&rsquo;)
})</p>

<p>`
写一个build.js，然后在package.json里面添加 script 参数</p>

<p>&ldquo;build&rdquo;: &ldquo;node build.js&rdquo;//这里记得写自己build.js路径
`</p>

<h3 id="5-甜点-马卡龙-有点腻">5. 甜点（马卡龙） 有点腻</h3>

<p><code>
上面的配置是可以更改的，例如你在loaders 里面加上
</code>
{
  test: /.vue$/,
  loader: &lsquo;vue&rsquo;
}
`
就可以变成支持.vue文件的vuejs打包构建，同理，修改下支持jsx，和添加一些reactjs的module，就可以用来跑Reactjs的东西。</p>

<p>还有可以随意更改Css预编译器的类型，用你自己喜欢就行，或者跟我们前面提到的方法，把所有类型都配置上，
`
var path = require(&lsquo;path&rsquo;)
var config = require(&lsquo;../config&rsquo;)
var ExtractTextPlugin = require(&lsquo;extract-text-webpack-plugin&rsquo;)</p>

<p>exports.assetsPath = function (_path) {
  return path.posix.join(config.build.assetsSubDirectory, _path)
}</p>

<p>exports.cssLoaders = function (options) {
  options = options || {}
  // generate loader string to be used with extract text plugin
  function generateLoaders (loaders) {
    var sourceLoader = loaders.map(function (loader) {
      var extraParamChar
      if (/\?/.test(loader)) {
        loader = loader.replace(/\?/, &lsquo;-loader?&rsquo;)
        extraParamChar = &lsquo;&amp;&rsquo;
      } else {
        loader = loader + &lsquo;-loader&rsquo;
        extraParamChar = &lsquo;?&rsquo;
      }
      return loader + (options.sourceMap ? extraParamChar + &lsquo;sourceMap&rsquo; : &ldquo;)
    }).join(&lsquo;!&rsquo;)</p>

<pre><code>if (options.extract) {
  return ExtractTextPlugin.extract('vue-style-loader', sourceLoader)
} else {
  return ['vue-style-loader', sourceLoader].join('!')
}
</code></pre>

<p>}</p>

<p>// <a href="http://vuejs.github.io/vue-loader/configurations/extract-css.html">http://vuejs.github.io/vue-loader/configurations/extract-css.html</a>
  return {
    css: generateLoaders([&lsquo;css&rsquo;]),
    postcss: generateLoaders([&lsquo;css&rsquo;]),
    less: generateLoaders([&lsquo;css&rsquo;, &lsquo;less&rsquo;]),
    sass: generateLoaders([&lsquo;css&rsquo;, &lsquo;sass?indentedSyntax&rsquo;]),
    scss: generateLoaders([&lsquo;css&rsquo;, &lsquo;sass&rsquo;]),
    stylus: generateLoaders([&lsquo;css&rsquo;, &lsquo;stylus&rsquo;]),
    styl: generateLoaders([&lsquo;css&rsquo;, &lsquo;stylus&rsquo;])
  }
}</p>

<p>// Generate loaders for standalone style files (outside of .vue)
exports.styleLoaders = function (options) {
  var output = []
  var loaders = exports.cssLoaders(options)
  for (var extension in loaders) {
    var loader = loaders[extension]
    output.push({
      test: new RegExp(&rsquo;\.&rsquo; + extension + &lsquo;$&rsquo;),
      loader: loader
    })
  }
  return output
}</p>

<p><code>
这就是把所有的css预编译的都加到配置里面了。
</code></p>

    
        

<h1 id="network">Network</h1>

    
        

<h2 id="cloud">Cloud</h2>

<p>云计算，是用互联网来接入存储或者运行在远程服务器端的应用，数据，服务。所以云计算行业包括了使用基于互联网的方法来计算，存储和开发的公司，或说是在互联网上提供其服务的公司。</p>

<h3 id="iaas-pass-saas">IaaS, PasS, SaaS</h3>

<p>云计算可以分为不同层次：基础设施-平台-软件，即 Infrastructure as a Service, Platform as a Service, Software as a Service。</p>

<ul>
<li><p>IaaS: Infrastructure-as-a-Service 基础设施即服务</p>

<p>提供了远程服务器、存储等网络硬件，使企业在运行应用时不再需要购买服务器等硬件，节省了维护成本和办公场地。实际提供 IaaS 的公司，如 Amozon，MicroSoft，VMWare，Rackspace，RedHat，不仅提供服务器，还会单独提供计算能力。</p></li>

<li><p>Paas: Platform-as-a-Service 平台即服务</p>

<p>PaaS，也可以叫中间件，使企业的所有开发都能够在这里进行，以节省时间和资源。PaaS 提供了各种开发和分发应用的解决方案，如虚拟服务器和操作系统。如网页应用管理、应用设计、应用虚拟主机、存储、安全、应用开发协作工具。</p>

<p>大型 PaaS 提供商有: Google App Engine, Microsoft Azure, Force.com, Heroku, Engine Yard; 以及新兴的 AppFog, Mendix, Standing Cloud.</p></li>

<li><p>SaaS: Software-as-a-Service 软件即服务</p>

<p>通过远程服务器来运行的应用，就属于 SaaS，也是消费者每天接触到的一层云服务。这类服务常由网页接入，商用+家用的如 Netflx, MOG, Google Apps, Box.net, Dropbox, iCloud。商用 SaaS 应用如 GoToMeeting (Citrix), WebEx (Cisco), CRM (Salesforce), ADP, SuccessFactors (Workday)。</p>

<p>SaaS 之前还有 Application Service Provider 的概念。SaaS 并不一定是B/S架构，重要的是让用户依赖于你在网络上提供的服务，而运营的重点也是如何持续稳定地提供服务。</p>

<p>除了业务服务本身外，SaaS 还需要保障几个服务：</p>

<ul>
<li>服务发现，寻找可用业务服务</li>
<li>模块更新，保证客户端模块更新</li>
<li>业务服务容器，提供业务服务</li>
<li>离线更新，保障分布式系统的数据安全 （？？）</li>
</ul>

<p>云计算并不是把局域网的东西放到广域网上。简单把东西放到网上，进行多用户租赁，只是最初级的SaaS。</p>

<p>SaaS 架构需要的支撑有：分布式计算，分布式数据存储和访问，分布式部署与运维。</p>

<ul>
<li>分布式计算模型是基础的模型。Hadoop 也是一种不太复杂的分布式计算模型。</li>
</ul></li>
</ul>

    
        

<h2 id="proxy">Proxy</h2>

<h3 id="正向代理与反向代理区别">正向代理与反向代理区别</h3>

<p>正向代理是位于客户端和原始服务器（origin server）之间的服务器。客户端向原始服务器请求内容时，向代理发送一个指定了目标的请求，由代理向原始服务器转发请求，然后将获得的内容返回客户端。客户端需要对发出的请求进行处理，使代理服务器了解请求的目标。</p>

<p>反向代理中，代理过程完全由客户端访问的服务器完成，代理过程对客户端不可见。客户端发出普通请求，反向代理服务器判断应向哪里的原始服务器转发请求，并将返回的内容作为响应转发回客户端。</p>

<p>正向代理中，客户端通过代理服务器隐藏了自身，如果需要安全性，可以在客户端连接代理服务器时进行鉴权。</p>

<p><strong>用途</strong></p>

<ul>
<li>正向代理：向在防火墙内的局域网客户端提供外网的访问；使用缓冲可以减少对外网的网络访问。</li>
<li>反向代理：向外网提供防火墙内的服务器访问；为后端多服务器提供负载平衡；为后端低速服务器提供缓冲；在一个URL空间下提供多服务器多页面的内容。</li>
</ul>

    
        

<h1 id="norm">Norm</h1>

    
        

<h2 id="code-review">Code Review</h2>

<h4 id="为什么做-code-review">为什么做 Code Review</h4>

<p>做 Code review 是为了改进代码质量. 通过对代码, 测试过程和注释进行检查, 来确认方案设计和代码实现.</p>

<p>Code review 的主要目的:</p>

<ol>
<li>保证代码质量</li>
</ol>

<ul>
<li>程序逻辑</li>
<li>需求和设计的实现</li>
<li>查找和排除系统缺陷</li>
<li>可读性</li>

<li><p>可维护性</p></li>

<li><p>保证项目组人员的良好沟通</p></li>

<li><p>项目或产品的代码更容易维护</p></li>
</ul>

<ol>
<li>提高参与者开发水平</li>
<li>传递作者的意图和想法，使其他人可以更加熟悉代码，利于维护代码和改进代码</li>
<li>评审过程使大家更多的理解系统，重构思路，</li>
<li>确定作者的设计和实现清晰，简单</li>
<li>帮助初级开发人员学习高级开发人员的经验，达到知识共享, 相互学习，提高开发者水平</li>
</ol>

<p>次要目的:
- 查找程序的bug
- 保证代码风格和编码标准
- 编码风格
- 避免开发人员犯一些很常见，很普通的错误
- 在项目早期就能够发现代码中的BUG</p>

<p>消除 Bug 主要靠测试. 由单元测试，功能测试，性能测试，回归测试来消除Bug。
单元测试为主。单元测试最接近bug，bug没有扩散的地方。
在 code review 之前，要有单元测试和单元测试报告，</p>

<p>代码风格和编码标准是确定的, 是靠个人可以做到的, 所以在代码提交时就应该是符合规范的。
代码规范，有作者自己和一些检查代码规范的工具。</p>

<p>规范性
- 注释格式
- 命名规范</p>

<ul>
<li>异常处理</li>
<li>日志处理</li>

<li><p>代码组织结构</p></li>

<li><p>业务实现</p></li>
</ul>

<p>在开发过程中, 对源代码进行系统检查.
查找代码缺陷,
检查功能实现,
编码合理性,
性能优化.</p>

<p>整理思路，流程的实现方法， 代码的组织方法（不是风格）</p>

<h4 id="cr-的过程">CR 的过程</h4>

<p>完整的 Code Review 包括三个阶段: 准备, 执行, 追踪</p>

<ol>
<li>准备

<ol>
<li>代码<br />
控制所要 review 的代码数量. 如果代码量比较大, 可对代码按功能模块进行分解,
确定(各部分的)关键代码, 对关键代码进行 review</li>
<li>review 的重点</li>
<li>规范<br />
review 的规范用于交流时的统一, 有标准可遁, 提高 review 沟通的效率效果</li>
<li>确定参与者<br />
把 review 的代码, 重点, 规范和流程发给所有参与者</li>
<li>执行方式
git 式, meeting 式, 1对1 / 多对1 式</li>
</ol></li>
<li>implement 执行<br />

<ol>
<li>准确记录<br />
对于CR过程发现的问题，我们必须清晰准确的记录，可以使用问题点记录单，明确记录的项目和内容。</li>
<li>讲解与提问
CR过程中，要采用代码作者讲解和审查者提问方式。审查者不能只在发现问题时提问，同时也要根据本次审查的内容要求代码作者对某个特定问题的讲解。</li>
<li>逐项审查<br />
对事前确定的审查内容，要逐项审查，不能因为时间不足等因素一扫而过。</li>
</ol></li>
<li>追踪

<ol>
<li>确认问题信息

<ul>
<li>问题的影响范围, 解决的难易程度</li>
<li>解决问题的时限</li>
<li>由谁来解决, 由谁来确认</li>
</ul></li>
<li>解决过程记录

<ul>
<li>问题的原因</li>
<li>解决对策</li>
<li>修改的内容</li>
</ul></li>
<li>确认结果<br />
按时限对修改结果进行全面确认</li>
</ol></li>
</ol>

<h4 id="说明">说明</h4>

<ol>
<li>经常做 Code Review, 保持较短的 review 间隔

<ul>
<li>一个人写代码的时间长了, 会在代码中加入越来越多的个性化的东西 :p</li>
<li>一次 review 的代码越多, 要修改重构的也越多, 会在讨论中产生太多口水</li>
<li>问题解决得越靠前, 总体上所要做的修改就越少</li>
</ul></li>

<li><p>Code Review 要快速, 不要拘泥形式</p>

<ul>
<li>严格按形式进行 Code Review 的问题:

<ul>
<li>只有在 checklist 上的项目才会被 review</li>
<li>reviewer 在形式上花的精力多了, 在实际思考代码上的精力和耐心就会少</li>
</ul></li>

<li><p>可以花5分钟, 给人讲一下你的代码, 然后花5分钟, 听听他对你代码的意见和想法</p></li>

<li><p>觉得有用处的地方, 再做成材料</p></li>

<li><p>要能放松, 再放松, 把真正想说的说出来</p></li>
</ul></li>
</ol>

<p>2.0. code review 的过程是讨论问题, 解决问题<br />
    记住Review只不过是一种形式，而只有在相互信任中通过相互的讨论得到了有意义和有建设性的建议和意见，那才是最实在的。不然，作者和评审者的关系就会变成小偷和警察的关系。</p>

<ol>
<li><p>每人都需要让不同的人 review 你的代码</p>

<ul>
<li>每次可以找两三个人来做 review, 这样3,4个人可以围在一起讨论, 每个人都能充分参与, 也不会因为意见太多降低执行的效率</li>
<li>不同的人有不同的思考方式, 对同一功能和设计的实现有不同的想法, 可以从不同方向更全面地来过你的代码</li>
<li>参与的人可以更好地理解你的代码, 团队中每个人的思考可以更同步, 在日后代码维护时相互帮助也更容易</li>
</ul></li>

<li><p>Enjoy 学会享受<br />
傲慢是程序员三大美德之一. 当看别人的代码时, 或者代码被人修改时, 自负的情绪会让人不容易接受不同的想法.
Code review 需要一种积极的态度提意见和接受意见, 不要抨击别人的代码, 不要质疑别人的能力,
给同事的建议和同事给的建议, 都是为了大家能做得更好.<br />
Code review 的核心是讨论问题, 解决问题.
团队里人人都喜欢讨论问题, 解决问题, 那每个人都能写高质量的代码,
大家相互学习, 相互帮助, 每个人都能更好地进化, 团队能快速适应变化.<br />
关键是, 开心的才是更好的 :-)</p></li>
</ol>

<h4 id="准备工作">准备工作</h4>

<ol>
<li>参与人对自己在 code review 要做什么, 要学什么有基本的了解</li>
<li>代码能正确运行/编译, 功能基本正确</li>
<li>代码能通过单元测试和测试用例</li>
<li>做 review 的人对代码有基本的了解,
代码的功能是什么, 涉及什么系统的什么方面, 对性能,稳定等方面有什么特别的需求,
好有针对性地检查代码</li>
</ol>

<p>Code review 前代码的语法和功能问题应该已经解决, review 的重点在代码质量上.</p>

<h4 id="git-提交">GIT 提交</h4>

<ol>
<li>提交日志有明确的含义，明确此次提交的内容或目的
像“修改了某文件”，“更行了某文件”提供的信息太少。</li>
</ol>

<p>写日志时考虑log的目的是在查找修改bug，版本回滚，代码评审等过程中提供有效的信息。</p>

<ol>
<li>提交的大小
提交的代码太多，不便于代码评审和版本控制.
提交太多太小的修改，会影响版本和日志的可读性。
可以参考的做法是，对一个模块完成修改，昨晚单元测试后，压缩commit之后提交。</li>
</ol>

<p>避免的做法：提交未测试的代码，出现问题后提交很多小的修改。</p>

<h4 id="review-项目">Review 项目</h4>

<p>基本方面
- 代码一致性
- 代码安全问题
- 代码冗余
- 设计的正确性
- 性能与功能需求</p>

<p>代码中使用的格式、符号、结构等风格是否保持一致</p>

<ol>
<li>完整性 completeness

<ol>
<li>完全实现设计文档中的功能需求</li>
<li>创建并初始化了所需要的数据库</li>
<li>去除了未定义或未使用的变量, 常量, 类</li>
</ol></li>
<li>一致性 consistency

<ol>
<li>代码逻辑与文档中逻辑是否一致</li>
<li>代码中的算法符合文档中的数学模型</li>
</ol></li>
<li>正确性 correctness

<ol>
<li>注释准确完整</li>
<li>函数调用参数传递正确</li>
<li>变量定义和使用方式正确</li>
<li>代码组织方式符合制定的标准</li>
</ol></li>
<li>清晰性 clearness

<ol>
<li>所需的数据字典, 接口说明, 描述如何访问常量, 变量, 功能</li>
<li>配置, 定义文件是否易于理解, 修改</li>
<li>功能模块功能的入口和出口明确, 唯一</li>
<li>函数的出口唯一 (异常处理除外)</li>
<li>每个功能都是一个可辩识的代码块</li>
</ol></li>
<li>可预测性 predictability

<ol>
<li>代码语言中常见陷阱已检测并排除</li>
<li>是否有依赖于开发工具环境语言缺省提供的功能</li>
<li>代码中没有死循环, 无穷递归</li>
</ol></li>
<li>健壮性 robustness

<ul>
<li>采取措施避免运行时错误: 数组边界溢出, 被零除, 值越界, 堆栈溢出, etc</li>
</ul></li>
<li>可追溯性 traceability

<ol>
<li>每个程序有唯一标识</li>
<li>代码和开发文档之间有交叉引用(框架)可以相互对应</li>
<li>代码版本管理中对代码的修改和原因都有易于理解的记录</li>
</ol></li>
<li>可读性 readability

<ol>
<li>注释清晰描述了每个子程序</li>
<li>复杂代码有必要的使用理由, 注释清楚明确</li>
<li>使用一些统一的格式化技巧（如缩进、空白等）用来增强代码的清晰度</li>
<li>变量, 函数的命名清楚反映含义, 便于记忆, 书写</li>
<li>变量都有合理合法的取值范围</li>
</ol></li>
<li>可验证性 verifiability

<ul>
<li>代码中功能的实现方式便于测试</li>
</ul></li>
</ol>

<h4 id="review-步骤">Review 步骤</h4>

<ol>
<li>作者向参与review的人按用例或功能依次讲解自己的代码功能, 相关逻辑</li>
<li>reviewer 提出疑问, 组织者对存在的问题做记录</li>
<li>reviewer 自己对代码进行审核, 并把问题和修改建议记录在表中</li>
<li>组织者把各reviewer的代码问题记录表汇总成&rdquo;review报告&rdquo;, 记录发现的问题和修改建议，然后把&rdquo;review报告&rdquo;发送给相关人员</li>
<li>作者根据&rdquo;review报告&rdquo;的修改意见修改代码, 有不清楚的地方和reviewer进行交流</li>
<li>作者在过完 issue 之后作出反馈</li>
<li>组织者把 Code Review 中发现的有价值的问题更新到 &ldquo;code review 规范&rdquo; 文档中</li>
<li>对值得提醒和注意的问题可 email 给所有技术人员</li>
</ol>

<h4 id="所需文档">所需文档</h4>

<ul>
<li>code review 规范</li>
<li>issue 记录表</li>
<li>issue 汇总表</li>
<li>issue 解决表</li>
<li>meeting 记录</li>
<li>output to protocol documents</li>
</ul>

<h4 id="ref">ref</h4>

<p>相关资料
<a href="http://coolshell.cn/articles/1218.html">5个开源的代码审查工具</a></p>

<p>资料来源</p>

<ul>
<li><a href="http://www.cnblogs.com/dinofung/articles/2302957.html">Code Reivew的执行</a></li>
<li><a href="http://coolshell.cn/articles/1302.html">Code Review中的几个提示</a></li>
<li><a href="http://www.cnblogs.com/wdpp/archive/2011/01/17/2386823.html">什么是Code Review</a></li>
<li><a href="http://blog.csdn.net/yzhz/article/details/1669802">web项目经理手册-Code Review</a></li>
</ul>

    
        

<h1 id="sql">SQL</h1>

    
        

<h2 id="declare-a-variable-in-mysql">Declare a Variable in MySQL</h2>

<p>(<a href="http://stackoverflow.com/questions/11754781/how-to-declare-a-variable-in-mysql">ref</a>)</p>

<p>There are mainly three types of variables in MySQL:</p>

<p>User-defined variables (prefixed with @):</p>

<p>You can access any user-defined variable without declaring it or initializing it. If you refer to a variable that has not been initialized, it has a value of NULL and a type of string.</p>

<p>SELECT @var_any_var_name
You can initialize a variable using SET or SELECT statement:</p>

<p>SET @start = 1, @finish = 10;<br />
or</p>

<p>SELECT @start := 1, @finish := 10;</p>

<p>SELECT * FROM places WHERE place BETWEEN @start AND @finish;
User variables can be assigned a value from a limited set of data types: integer, decimal, floating-point, binary or nonbinary string, or NULL value.</p>

<p>User-defined variables are session-specific. That is, a user variable defined by one client cannot be seen or used by other clients.</p>

<p>They can be used in SELECT queries using Advanced MySQL user variable techniques.
Local Variables (no prefix) :</p>

<p>Local variables needs to be declared using DECLARE before accessing it.</p>

<p>They can be used as local variables and the input parameters inside a stored procedure:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">DELIMITER</span> <span class="o">//</span>

<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">sp_test</span><span class="p">(</span><span class="n">var1</span> <span class="nb">INT</span><span class="p">)</span> 
<span class="k">BEGIN</span>   
    <span class="k">DECLARE</span> <span class="k">start</span>  <span class="nb">INT</span> <span class="n">unsigned</span> <span class="k">DEFAULT</span> <span class="mi">1</span><span class="p">;</span>  
    <span class="k">DECLARE</span> <span class="n">finish</span> <span class="nb">INT</span> <span class="n">unsigned</span> <span class="k">DEFAULT</span> <span class="mi">10</span><span class="p">;</span>

    <span class="k">SELECT</span>  <span class="n">var1</span><span class="p">,</span> <span class="k">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">;</span>

    <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">places</span> <span class="k">WHERE</span> <span class="n">place</span> <span class="k">BETWEEN</span> <span class="k">start</span> <span class="k">AND</span> <span class="n">finish</span><span class="p">;</span> 
<span class="k">END</span><span class="p">;</span> <span class="o">//</span>

<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">CALL</span> <span class="n">sp_test</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>

<p>If the DEFAULT clause is missing, the initial value is NULL.</p>

<p>The scope of a local variable is the BEGIN &hellip; END block within which it is declared.
Server System Variables (prefixed with @@):</p>

<p>The MySQL server maintains many system variables configured to a default value. They can be of type GLOBAL, SESSION or BOTH.</p>

<p>Global variables affect the overall operation of the server whereas session variables affect its operation for individual client connections.</p>

<p>To see the current values used by a running server, use the SHOW VARIABLES statement or SELECT @@var_name.</p>

<p>SHOW VARIABLES LIKE &lsquo;%wait_timeout%&lsquo;;</p>

<p>SELECT @@sort_buffer_size;</p>

<p>They can be set at server startup using options on the command line or in an option file. Most of them can be changed dynamically while the server is running using SET GLOBAL or SET SESSION:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="c1">-- Syntax to Set value to a Global variable:</span>
<span class="k">SET</span> <span class="k">GLOBAL</span> <span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">;</span>
<span class="k">SET</span> <span class="o">@@</span><span class="k">global</span><span class="p">.</span><span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">;</span>

<span class="c1">-- Syntax to Set value to a Session variable:</span>
<span class="k">SET</span> <span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">;</span>
<span class="k">SET</span> <span class="k">SESSION</span> <span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">;</span>
<span class="k">SET</span> <span class="o">@@</span><span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">;</span>
<span class="k">SET</span> <span class="o">@@</span><span class="k">local</span><span class="p">.</span><span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">;</span>
</code></pre></div>

    
        

<h1 id="tools">Tools</h1>

    
        

<h2 id="makefile">Makefile</h2>

<h3 id="make-basic">Make Basic</h3>

<p><em>make</em> is designed to manage the compiling process based on dependencies. The other functions of make is designed to make it easier to write Makefile.</p>

<hr />

<p>When we deal with a complex project, there might be lots of source files, header files, lib files, target files.
The files have a certain dependency relationship.</p>

<pre><code>$ gcc -c -o test.o test.c
$ gcc -o helloworld test.o
</code></pre>

<p>The dependency line is: <code>test.c</code> -&gt; <code>test.o</code> -&gt; <code>helloworld</code>.</p>

<p>When dealing with many files, the compiler is called many times. We build the files on which is depended, then build target files on top of that.</p>

<p>And <em>make</em> is a tool to automatically record and process the dependency.
The dependency relationship is written in the Makefile file, and <em>make</em> will compile the files w.r.t. the dependency described in Makefile.</p>

<h4 id="dependency">Dependency</h4>

<p>Here is a basic Makeifle</p>

<pre><code># target binary file: helloworld
helloworld: test.o
	echo &quot;good&quot;
	gcc -o helloworld test.o

test.o: test.c
	gcc -c -o test.o test.c
</code></pre>

<ul>
<li># starts a comment line</li>
<li>a target depends on its prerequisite. Multiple files are separated by spaces.</li>
<li>The lines indented by Tab are operations to implement a dependency relationship. These operations are normal Shell commands.</li>
</ul>

<p><em>make</em> is a recursive process.</p>

<blockquote>
<ul>
<li>If the current dependency has not prerequisite, then execute operations directly.</li>
<li>If the current dependency has prerequisite, and the required files exist and have not been changed since the last make (judged by write-timestamp), then execute operations directly.</li>
<li>If the required files of the current dependency do not exist, or have been changed, then use the required files as target files, and search their dependency, create target files.</li>
</ul>
</blockquote>

<h4 id="macro">Macro</h4>

<p>Macro in <em>make</em> is text-type variable.</p>

<pre><code>CC = gcc
helloworld: test.o
　　echo &quot;good&quot;
　　$(CC) -o helloworld test.o

test.o: test.c
　　$(CC) -c -o test.o test.c
</code></pre>

<h4 id="inner-macro">Inner Macro</h4>

<ul>
<li><code>$@</code> is target filename of the current dependency.</li>
<li><code>$^</code> is required filenames of the current dependency.</li>
<li><code>$*</code> target filename without suffix of the current dependency</li>
<li><code>$*</code> the changed files in the current dependency</li>
<li><code>$$</code> character $</li>
<li><code>$(@D)</code> directory of file path</li>
<li><code>$(@F)</code> filename of file path</li>
</ul>

<pre><code>CC = gcc
helloworld: test.o
　　echo $@
　　$(CC) -o $@ $^

test.o: test.c
　　$(CC) -c -o $@ $^
</code></pre>

<h4 id="suffix-dependency">Suffix Dependency</h4>

<pre><code>CC = gcc

.SUFFIXES: .c .o

.c.o:
	$(CC) -c -o $@ $^

#--------------------------
helloworld: test.o
	echo $@
	$(CC) -o $@ $^

test.o: test.c
</code></pre>

<p><code>.c.o</code> means <code>.c</code> is prerequisite, and <code>.o</code> is target.
<em>make</em> will find test.o and test.c has dependency, and will execute operation for this dependency.</p>

<p>Suffix dependency is very handy is big projects.</p>

<h4 id="misc">Misc</h4>

<p>Special dependency in makefile.</p>

<p>all: if <em>make</em> was followed by no filename, &ldquo;all&rdquo; will be chosen.</p>

<p>clean: it is used to clean legacy files.</p>

<pre><code>CC = gcc

.SUFFIXES: .c .o

.c.o:
        $(CC) -c -o $@ $^

#--------------------------

all: helloworld
        @echo &quot;ALL&quot;

helloworld: test.o
        @echo $@
        $(CC) -o $@ $^

test.o: test.c

clean:
        -rm helloworld *.o
</code></pre>

<p>&rsquo;@&rsquo; will hide the following command itself.
&lsquo;-&rsquo; will ignore the stderr of the following command.</p>

    
        

<h1 id="python">Python</h1>

<h2 id="class-自带函数">Class 自带函数</h2>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">Foor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Bar</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Bar</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">)</span>
        
<span class="n">foo</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">()</span>
<span class="n">foo</span><span class="p">()</span>

<span class="c1"># Result:</span>
<span class="n">new</span>
<span class="n">init</span>
<span class="n">call</span>
</code></pre></div>

<ul>
<li><p><code>__init__(self, *args, **kwargs)</code><br />
在对象创建完成后调用，对当前对象实例进行初始化，无返回值。</p></li>

<li><p><code>__new__(cls, *args, **kwargs)</code><br />
创建对象时调用，返回当前对象的一个实例。</p></li>

<li><p><code>__call__(self, *args, **kwargs)</code><br />
重载括号运算符。类实现了call方法，则其对象可当作函数使用。</p></li>
</ul>

<h2 id="用自带函数实现单例">用自带函数实现单例</h2>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">MySingleton</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;_instance&#39;</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MySingleton</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span>
</code></pre></div>

    
        
    
        
    
        <p>review 记录：作者记录，表格记录，checkout -b review， checkout -b review_by_Foo, git pull &amp;&amp; checkout -b review_by_Foo</p>

<p><a href="http://blog.csdn.net/haoel/article/details/4469526">http://blog.csdn.net/haoel/article/details/4469526</a></p>

<p><a href="http://blog.csdn.net/haoel/article/details/4469462">http://blog.csdn.net/haoel/article/details/4469462</a></p>

<p><a href="http://www.cnblogs.com/lhb25/p/15-best-code-review-tools-for-developers.html">http://www.cnblogs.com/lhb25/p/15-best-code-review-tools-for-developers.html</a></p>

<p>Code Review中的几个提示</p>

<p>Code Review应该是软件工程最最有价值的一个活动，之前，本站发表过《简单实用的Code Review工具》，那些工具主要是用来帮助更有效地进行这个活动，这里的这篇文章，我们主要想和大家分享一下Code Review代码审查的一些心得。</p>

<p>首先，我们先来看看Code Reivew的用处：</p>

<p>Code reviews 中，可以通过大家的建议增进代码的质量。
Code reviews  是一个传递知识的手段，可以让其它并不熟悉代码的人知道作者的意图和想法，从而可以在以后轻松维护代码。
Code reviews 也鼓励程序员们相互学习对方的长处和优点。
Code reviews 也可以被用来确认自己的设计和实现是一个清楚和简单的。
你也许注意到了在上面的Code Reivew中的诸多用处中，我们没有提到可以帮助找到程序的bug和保证代码风格和编码标准。这是因为我们认为：</p>

<p>Code reviews 不应该承担发现代码错误的职责。Code Review主要是审核代码的质量，如可读性，可维护性，以及程序的逻辑和对需求和设计的实现。代码中的bug和错误应该由单元测试，功能测试，性能测试，回归测试来保证的（其中主要是单元测试，因为那是最接近Bug，也是Bug没有扩散的地方）</p>

<p>所以，在今天，请不要把上面的那两件事分散了Code Review的注意力，取而代之的是，对于Bug，程序的作者要在Review前提交自己的单元测试报告（如：XUnit的测试结果），对于代码规范，这是程序作者自己需要保证的，而且，有一些工具是可以帮你来检查代码规范的。</p>

<p>不是说不能在Code Review中报告一个程序的bug或是一个代码规范的问题。只是说那并不是Code Review的意图。</p>

<p>1.- 经常进行Code Review
以前经历过几个相当痛苦的Code Review，那几次Code Review都是在程序完成的时候进行的，当你面对那近万行的代码，以前N我掺和在一起的功能，你会发现，整个Code Review变得非常地艰难，用不了一会儿，你就会发现大家都在拼命地打着哈欠，但还是要坚持，有时候，这样的Review会持续3个小时以上，相当的夸张。而且，会议上会出现相当多的问题和争论，因为，这就好像，人家都把整个房子盖好了，大家Review时这挑一点那挑一点，有时候触动地基或是承重墙体，需要大动手术，让人返工，这当然会让盖房的人一下就跳起来极力地维护自己的代码，最后还伤了团队成员的感情。</p>

<p>所以，千万不要等大厦都盖好了再去Reivew，而且当有了地基，有了框架，有了房顶，有了门窗，有了装修，的各个时候循序渐进地进行Review，这样反而会更有效率，也更有帮助。</p>

<p>下面是一些观点，千万要铭记：</p>

<p>要Review的代码越多，那么要重构，重写的代码就会越多。而越不被程序作者接受的建议也会越多，唾沫口水战也会越多。
程序员代码写得时候越长，程序员就会在代码中加入越来越多的个人的东西。 程序员最大的问题就是“自负”，无论什么时候，什么情况下，有太多的机会会让这种“自负”澎涨开来，并开始影响团队影响整个项目，以至于听不见别人的建议，从而让Code Review变成了口水战。
越接近软件发布的最终期限，代码也就不能改得太多。
我个人的习惯，并且也是对团队成员的要求是——先Review设计实现思路，然后Review设计模式，接着Review成形的骨干代码，最后Review完成的代码，如果程序复杂的话，需要拆成几个单元或模块分别Review。当然，最佳的practice是，每次Review的代码应该在1000行以内，时间不能超过一部电影的时间——1.5小时（因为据说那个一个正常人的膀胱可以容纳尿液的最长限度）</p>

<p>当然，在敏捷开发中，他们不需要Code Reivew，其实，敏捷开发中使用更为极端的“结对编程”（Pair-Programming）的方法 —— 一种时时刻刻都在进行Code Review的方法，个人感觉在实际过程中，这种方法有点过了。另外，大家可以看看本站的另一篇文章《结对编程的利与弊》来了解一下这种方法的问题。</p>

<p>3.- 尽可能的让不同的人Reivew你的代码
这是一个好主意，如果可能的话，不要总是只找一个人来Review你的代码，不同的人有不同的思考方式，有不同的见解，所以，不同的人可以全面的从各个方面评论你的代码，有的从实现的角度，有的从需求的角度，有的从用户使用的角度，有的从算法的角度，有的从性能效率的角度，有的从易读的角度，有的从扩展性的角度……，啊，好多啊，还让不让人活了。不管怎么说，多找一些不同的人会对你很有好处。当然，不要太多了，人多嘴杂反而适得其反，基本上来说，不要超过3个人，这是因为，这是一个可以围在一起讨论的最大人员尺寸。</p>

<p>从不同的方向评审代码总是好的。
会有更多的人帮你在日后维护你的代码。
这也是一个增加团队凝聚力的方法。</p>

<p>Code Review中文应该译作“代码审查”或是“代码评审”，这是一个流程，当开发人员写好代码后，需要让别人来review一下他的代码，这是一种有效发现BUG的方法。由此，我们可以审查代码的风格、逻辑、思路……，找出问题，以及改进代码。因为这是代码刚刚出炉的时候，所以，这也是代码重构，代码调整，代码修改的最佳时候。所以，Code Review是编码实现中最最重要的一个环节。</p>

<p>长时间以来，Code Review需要有一些有效的工具来支持，这样我们就可以更容易，更有效率地来进行代码审查工作。下面是5个开源的代码审查工具，他们可以帮助你更容易地进行这项活动。</p>

<ol>
<li>Review board:
Review board 是一个 基于web 的工具，主要设计给 django 和python的用户。 Review board 可以帮助我们追踪待决代码的改动，并可以让Code-Review更为容易和简练。尽管Review board 最初被设计在VMware项目中使用，但现在其足够地通用。当前，其支持这些代码版本管理软件： SVN, CVS, Perforce, Git, Bazaar, 和Mercurial.</li>
</ol>

<p>Yahoo 是review-board的其中一个用户。</p>

<p>“Review board 已经改变了代码评审的方式，其可以强迫高质量的代码标准和风格，并可以成为程序员编程的指导者。每一次，当你访问search.yahoo.com 时，其代码都是使用 Review board工具Review过的。 We’re great fans of your work!” – Yahoo! Web Search</p>

<p>Detailed review requests
Powerful diff viewer</p>

<ol>
<li>Codestriker:
Codestriker 也是一个基于Web的应用，其主要使用 GCI-Perl 脚本支持在线的代码审查。Codestriker 可以集成于CVS, Subversion, ClearCase, Perforce 和Visual SourceSafe。并有一些插件可以提供支持其它的源码管理工具。</li>
</ol>

<p>David Sitsky 是 Codestriker 的作者，并也是最活跃的开发人员之一。 Jason Remillard 是另一个活路的开发者，并给这个项目提供了最深远最有意义的贡献。大量的程序员贡献他们的代码给 Codestriker 项目，导致了这个项目空前的繁荣。</p>

<p><a href="http://codestriker.sourceforge.net/viewtopicdetail.png">http://codestriker.sourceforge.net/viewtopicdetail.png</a></p>

<ol>
<li>Groogle:
Groogle 是一个基于WEB的代码评审工具。 Groogle 支持和 Subversion 集成。它主要提供如下的功能：</li>
</ol>

<p>各式各样语言的语法高亮。
支持整个版本树的比较。
支持当个文件不同版本的diff功能，并有一个图形的版本树。
邮件通知所有的Reivew的人当前的状态。
认证机制。
Screenshot</p>

<ol>
<li><p>Rietveld:
Rietveld 由Guido van Rossum 开发（他是Python的创造者，现在是Google的员工），这个工具是基于Mondrian 工具，作者一开始是为了Google 开发的，并且，它在很多方面和Review board 很像。它也是一个基于Web的应用，并可以Google App Engine 当主机。它使用了目前最流行的Web开发框架 django 并支持 Subversion 。当前，任何一个使用 Google Code 的项目都可以使用 Rietveld 并且使用 python Subversion 服务器。当然，它同样支持其它的Subversion服务器。</p></li>

<li><p>JCR
JCR 或者叫做 JCodeReview 也是一个基于WEB界面的最初设计给Reivew Java 语言的一个工具。当然，现在，它可以被用于其它的非Java的代码。</p></li>
</ol>

<p>JCR 主要想协助：</p>

<p>审查者。所有的代码更改都会被高亮，以及大多数语言的语法高亮。Code extracts 可以显示代码评审意见。如果你正在Review Java的代码，你可以点击代码中的类名来查看相关的类的声明。
项目所有者。可以 轻松创建并配置需要Review的项目，并不需要集成任何的软件配置管理系统（SCM）。
流程信仰者。 所有的评语都会被记录在数据库中，并且会有状态报告，以及各种各样的统计。
架构师和开发者。 这个系统也可以让我们查看属于单个文件的评语，这样有利于我们重构代码。
JCR 主要面对的是大型的项目，或是非常正式的代码评审，从这方面看来，他并不像上面的那些工具。</p>

<p>Screenshot</p>

<p>Jupiter：最后我们要提一下Jupiter，这是另一个代码review的工具你可以去考虑使用的，它是一个Eclipse IDE 的插件。</p>

    
        

<h1 id="new-t1-算法-schedule-48">new T1 算法 Schedule 48</h1>

<p><span style="font-size:small">所有时间估计实施时长乘系数 0.5~3</span></p>

<h2 id="程序">程序</h2>

<h3 id="apps-23-5-3">apps 23.5 + 3*?</h3>

<ul>
<li>bills 4.5

<ul>
<li>list <sup>1</sup>&frasl;<sub>4</sub></li>
<li>get <sup>1</sup>&frasl;<sub>4</sub></li>
<li>入库 1</li>
<li>出库 1</li>
<li>指定单据入库退货manual 1</li>
<li>指定单据出库退货manual 1</li>
</ul></li>

<li><p>stocks 11 + ? + ? + ?</p>

<ul>
<li>app.stocks 3 + ?

<ul>
<li>入库 <sup>1</sup>&frasl;<sub>4</sub></li>
<li>出库 <sup>1</sup>&frasl;<sub>4</sub></li>
<li>list <sup>1</sup>&frasl;<sub>8</sub></li>
<li>get <sup>1</sup>&frasl;<sub>8</sub></li>
<li>指定单据入库退货manual 1</li>
<li>指定单据出库退货manual <sup>5</sup>&frasl;<sub>4</sub></li>
<li>修改 ？？</li>
</ul></li>
<li>api.settlement 3 + ?

<ul>
<li>入库 <sup>1</sup>&frasl;<sub>4</sub></li>
<li>出库 <sup>1</sup>&frasl;<sub>4</sub></li>
<li>list <sup>1</sup>&frasl;<sub>8</sub></li>
<li>get <sup>1</sup>&frasl;<sub>8</sub></li>
<li>指定单据入库退货manual 1</li>
<li>指定单据出库退货manual <sup>5</sup>&frasl;<sub>4</sub></li>
<li>修改 ？？</li>
</ul></li>
<li>关联表 1

<ul>
<li>出库关联 <sup>1</sup>&frasl;<sub>8</sub></li>
<li>关联修改 <sup>1</sup>&frasl;<sub>8</sub></li>
<li><strong>关联调用</strong> <sup>3</sup>&frasl;<sub>4</sub></li>
</ul></li>
<li>app.inventory 4 + ?

<ul>
<li>入库 <sup>1</sup>&frasl;<sub>2</sub></li>
<li>出库 <sup>1</sup>&frasl;<sub>2</sub></li>
<li>list <sup>1</sup>&frasl;<sub>8</sub></li>
<li>get <sup>1</sup>&frasl;<sub>8</sub></li>
<li>指定单据入库退货manual <sup>5</sup>&frasl;<sub>4</sub></li>
<li>指定单据出库退货manual <sup>6</sup>&frasl;<sub>4</sub></li>
<li>修改 ？？</li>
</ul></li>
</ul></li>

<li><p>queues 8</p>

<ul>
<li>入队</li>
<li>处理</li>
<li>完成</li>
<li>单记录单步的操作</li>
<li>单记录顺序的操作</li>
<li>插入新记录的处理</li>
<li>多记录</li>
<li>清除</li>
</ul></li>
</ul>

<h3 id="models-8">models 8</h3>

<ul>
<li>settlement 修改 1<br />
2016-12-25 数据库单元用例时发现的settlement的问题</li>
<li>inventory 全部 3</li>
<li>queues 全部 4</li>
</ul>

<h2 id="单元用例-12">单元用例 12</h2>

<ul>
<li>bills 4</li>
<li>stocks 4

<ul>
<li>stocks 1+</li>
<li>settlement 1+</li>
<li>inventory 1+</li>
</ul></li>
<li>queues 4</li>
</ul>

<h2 id="集成用例-4">集成用例 4</h2>

<ul>
<li>出入库 4</li>
<li>指定单据退货manual</li>
</ul>

<h2 id="解决方案-8">解决方案 8</h2>

<pre><code>超过8小时就不做，先确定问题
</code></pre>

<p>指定单据退货fifo
指定单据退货avg
不指定单据退货manual
不指定单据退货fifo
不指定单据退货avg
修改单据</p>

    

        </div>
        <div class="dark-box">
            
            <div class="lang-selector">
                
                <a href="#" data-language-name="go">Go</a>
                
                <a href="#" data-language-name="c&#43;&#43;">C</a>
                
                <a href="#" data-language-name="shell">Shell</a>
                
                <a href="#" data-language-name="python">Python</a>
                
                <a href="#" data-language-name="javascript">Javascript</a>
                
                <a href="#" data-language-name="sql">SQL</a>
                
            </div>
            
        </div>
    </div>
    
</body>
</html>
